(function(s,u){typeof exports=="object"&&typeof module<"u"?module.exports=u():typeof define=="function"&&define.amd?define(u):(s=typeof globalThis<"u"?globalThis:s||self,s.CuboPagoSDK=u())})(this,function(){"use strict";var D=Object.defineProperty;var P=(s,u,l)=>u in s?D(s,u,{enumerable:!0,configurable:!0,writable:!0,value:l}):s[u]=l;var c=(s,u,l)=>P(s,typeof u!="symbol"?u+"":u,l);var s=(n=>(n.ICC="ICC",n.MCR="MCR",n.NFC_ONLINE="NFC_ONLINE",n.NFC_OFFLINE="NFC_OFFLINE",n.NFC_DECLINED="NFC_DECLINED",n.TRY_ANOTHER_INTERFACE="TRY_ANOTHER_INTERFACE",n.BAD_SWIPE="BAD_SWIPE",n.NONE="NONE",n.NOT_ICC="NOT_ICC",n.NO_RESPONSE="NO_RESPONSE",n.NO_UPDATE_WORK_KEY="NO_UPDATE_WORK_KEY",n))(s||{}),u=(n=>(n.POS="POS",n.POS_MSI="POS-MSI",n.LINK="LINK",n.LINK_MSI="LINK-MSI",n.QR="QR",n))(u||{}),l=(n=>(n.NFC="NFC",n.CHIP="CHIP",n))(l||{});const E=`"use strict";var CardTradeMode={CardTradeMode_ONLY_INSERT_CARD:1,CardTradeMode_ONLY_SWIPE_CARD:2,CardTradeMode_SWIPE_INSERT_CARD:5,CardTradeMode_UNALLOWED_LOW_TRADE:4,CardTradeMode_SWIPE_TAP_INSERT_CARD:3,CardTradeMode_SWIPE_TAP_INSERT_CARD_UNALLOWED_LOW_TRADE:6,CardTradeMode_ONLY_TAP_CARD:7,CardTradeMode_SWIPE_TAP_INSERT_CARD_NOTUP:8,CardTradeMode_SWIPE_TAP_INSERT_CARD_NOTUP_UNALLOWED_LOW_TRADE:9,CardTradeMode_TAP_INSERT_CARD:11,CardTradeMode_TAP_INSERT_CARD_NOTUP:10,CardTradeMode_SWIPE_TAP_INSERT_CARD_DOWN:12},CommunicationMode={BLUETOOTH:0,USB:1,BLUETOOTH_BLE:2,UART:3},EMVDataOperation={CLEAR:0,ADD:1,DELETE:2,ATTAINLIST:3,UPDATE:4,GETEMV:5},TransactionType={GOODS:1,SERVICES:2,CASH:3,CASHBACK:4,INQUIRY:5,TRANSFER:6,ADMIN:7,CASHDEPOSIT:8,PAYMENT:9,PBOCLOG:10,SALE:11,PREAUTH:12,ECQ_DESIGNATED_LOAD:16,ECQ_UNDESIGNATED_LOAD:17,ECQ_CASH_LOAD:18,ECQ_CASH_LOAD_VOID:19,ECQ_INQUIRE_LOG:10,REFUND:20,SALES_NEW:21,LEGACY_MONEY_ADD:22,NON_LEGACY_MONEY_ADD:23,BALANCE_UPDATE:24,UPDATE_PIN:240},UpdateInformationResult={};function anlycPosInfo(){var e=upPLength(),t=0,n=getUpPByte(t++),r=hex2Ascii(byteArray2Hex(getUpPBytes(t,n))),n=(t+=n,getUpPByte(t++)),a=hex2Ascii(byteArray2Hex(getUpPBytes(t,n))),n=(t+=n,getUpPByte(t++)),o=byteArray2Hex(getUpPBytes(t,n)),s="",n=(3<(o=hex2Ascii(o)).length&&(s=o.substr(3,n),o=o.substr(0,3)),t+=n,getUpPByte(t++)),i=byteArrayToInt(getUpPBytes(t,n))+" mV",n=(t+=n,getUpPByte(t++)),u="00"==(u=byteArray2Hex(getUpPBytes(t,n)))?"false":"true",n=(t+=n,getUpPByte(t++)),l="00"==(l=byteArray2Hex(getUpPBytes(t,n)))?"false":"true",n=(t+=n,getUpPByte(t++)),C="00"==(C=byteArray2Hex(getUpPBytes(t,n)))?"false":"true",n=(t+=n,getUpPByte(t++)),c="00"==(c=byteArray2Hex(getUpPBytes(t,n)))?"false":"true",n=(t+=n,getUpPByte(t++)),m="00"==(m=byteArray2Hex(getUpPBytes(t,n)))?"false":"true",p="",n=((t+=n)<e&&(n=getUpPByte(t++),p=byteArray2Hex(getUpPBytes(t,n)),t+=n),""),p=(t<e&&(p=getUpPByte(t++),n="00"==(n=byteArray2Hex(getUpPBytes(t,p)))?"false":"true",t+=p),""),y=(t<e&&(y=getUpPByte(t++),p="00"==(p=byteArray2Hex(getUpPBytes(t,y)))?"false":"true",t+=y),""),d=(t<e&&(f=getUpPByte(t++),100<(d=getUpPBytes(t,f)[0])?d=100:d<0&&(d=0),y=d.toString(10),y+="%",t+=f),""),f=(t<e&&(f=getUpPByte(t++),d=hex2Ascii(d=byteArray2Hex(getUpPBytes(t,f))),t+=f),""),g=(t<e&&(g=getUpPByte(t++),f=hex2Ascii(f=byteArray2Hex(getUpPBytes(t,g))),t+=g),""),e=(t<e&&(e=getUpPByte(t++),g=hex2Ascii(g=byteArray2Hex(getUpPBytes(t,e))),t+=e),8==g.length&&(g=g.slice(0,6)+"_"+g.slice(6)),"");return o.startsWith("A27")?e="QPOSMINI":o.startsWith("A29")?e="QPOSCUTE":o.startsWith("A30")?e="QPOSPLUS":o.startsWith("D20")?e="D20":o.startsWith("CR1")&&(e="CR100"),{isSupportedTrack1:C,isSupportedTrack2:c,isSupportedTrack3:m,bootloaderVersion:r,firmwareVersion:a,isUsbConnected:l,isCharging:u,batteryLevel:i,hardwareVersion:o,SUB:s,updateWorkKeyFlag:n,keyboardflag:p,batteryPercentage:y,pciHardWareVer:d,pciFirmwareVer:f,compileTime:g,Manufacturere:"Dspread",ModelInfor:e,Voltage:i}}function anlycPosId(){var e,t=upPLength(),n=0,r=getUpPByte(n++),a=byteArray2Hex(getUpPBytes(n,r)),r=(n+=r,getUpPByte(n++)),o=byteArray2Hex(getUpPBytes(n,r)),r=(n+=r,getUpPByte(n++)),r=(byteArray2Hex(getUpPBytes(n,r)),n+=r,getUpPByte(n++)),r=(byteArray2Hex(getUpPBytes(n,r)),(n+=r)<t&&(r=getUpPByte(n++),byteArray2Hex(getUpPBytes(n,r)),n+=r,r=getUpPByte(n++),byteArray2Hex(getUpPBytes(n,r)),n+=r),"");return n<t&&(e=getUpPByte(n++),r=byteArray2Hex(getUpPBytes(n,e)),n+=e),n<t&&(e=getUpPByte(n++),byteArray2Hex(getUpPBytes(n,e)),n+=e,e=getUpPByte(n++),byteArray2Hex(getUpPBytes(n,e)),n+=e,e=getUpPByte(n++),byteArray2Hex(getUpPBytes(n,e)),n+=e,e=getUpPByte(n++),byteArray2Hex(getUpPBytes(n,e)),n+=e,e=getUpPByte(n++),byteArray2Hex(getUpPBytes(n,e)),n+=e),n<t&&(e=getUpPByte(n++),byteArray2Hex(getUpPBytes(n,e)),n+=e),{posId:o,csn:r,psamId:a}}UpdateInformationResult.UPDATE_SUCCESS="UPDATE_SUCCESS",UpdateInformationResult.UPDATE_FAIL="UPDATE_FAIL",UpdateInformationResult.UPDATE_PACKET_VEFIRY_ERROR="UPDATE_PACKET_VEFIRY_ERROR",UpdateInformationResult.UPDATE_LOWPOWER="UPDATE_LOWPOWER",UpdateInformationResult.UPDATE_NOT_KEEP_CHARGING="UPDATE_NOT_KEEP_CHARGING";var myConnectType,CmdId={CMDID_WAITING:35,CMDID_QUERY:34,CMDID_PART_DATA:54,CMDID_OLD:0,CMDID_RESET:32,CMDID_PROCESS:33,CMDID_COMPLETED:36,CMDID_TIMEOUT:37,CMDID_DESTRUCT:38,CMDID_CRCERROR:39,CMDID_USERCANCEL:40,CMDID_MACERROR:41,CMDID_ICC_INIT_ERROR:48,CMDID_ICC_POWER_ON_ERROR:49,CMDID_ICC_TRADE_ERROR:50,CMDID_EMV_TRANS_TERMINATE:51,CMDID_EMV_TRANS_DENIAL:52,CMDID_NOT_AVAILABLE:53,CMDID_COMPLETED_ENCRY:136,CMDID_EMV_APP_CFG_ERROR:55,CMDID_EMV_CAPK_CFG_ERROR:56,CMDID_WR_DATA_ERROR:57,CMDID_NO_UPDATE_WORK_KEY:64,CMDID_INPUT_PIN_ING:65,CMDID_MAG_TO_ICC_TRADE:66,CMDID_SEND_IC_CARDNO:67,CMDID_EMV_TRANS_CARD_BLOCKED_OR_EMV_APPS:68,CMDID_EMV_TRANS_SELECT_APP_FAILED:69,CMDID_EMV_TRANS_CAPK_FAILED:70,CMDID_EMV_TRANS_FALLBACK:71,CMDID_EMV_TRANS_TERMINATE_NFC:72,CMDID_CARD_REMOVED:81,CMDID_MSR_DATA_READY:82,CMDID_EMV_KERNEL_PC:73,CMDID_CHECK_HAVE_CARD:137,CMDID_EMV_TRANS_TRY_ANOTHER_INTERFACE:86};function CommandDownlink(e,t,n){packCmmandDownlink(33,e,t,n,[])}function CommandDownlink2(e,t,n,r){packCmmandDownlink(33,e,t,n,r)}function CommandDownlink3(e,t,n,r,a){packCmmandDownlink(e,t,n,r,a)}function CommandDownlink4(e,t,n,r){packCmmandDownlink(e,t,n,r,[])}function getDownPByte(e){return getPByte(e)}function getDownPBytes(){return getPBytes()}function packCmmandDownlink(e,t,n,r,a){packet(a.length),setCmdID(e),setCmdCode(t),setCmdSubCode(n),setTimeOut(r),setDataField(a),buildCRC()}function commandCode(){return getCmdCode()}function subCommandCode(){return getCmdSubCode()}function getResult(){return getResultCode()}function commandID(){return getCmdID()}function upPLength(){var e=[];return e[0]=getPByte(3),e[1]=getPByte(4),byteArrayToInt(e)}function getUpPByte(e){return getDataFieldByte(e)}function getUpPBytes(e,t){for(var n=[],r=0;r<t;r++)n[r]=getDataFieldByte(e+r);return n}function getAllBytes(){return getPBytes()}function validCRC(){return validPCRC()}function packageCommandUplink(e){var t=hexStr2Bytes(e.substring(10,e.length));packet(e.length/2-5),setCmdID(CmdId.CMDID_COMPLETED),setCmdCode(parseInt(e.substring(0,2),16)),setCmdSubCode(parseInt(e.substring(2,4),16)),setTimeOut(0),setDataField(t),buildCRC()}function resetQPosStatus(){myConnectType==CommunicationMode.BLUETOOTH?startSessionBluetooth(packageInstructionReset(),null,5):myConnectType==CommunicationMode.USB?startSessionUSB(packageInstructionReset(),null,5):myConnectType==CommunicationMode.UART&&startSessionSerial(packageInstructionReset(),null,5)}function startSession(e,t,n){myConnectType==CommunicationMode.BLUETOOTH?startSessionBluetooth(e,t,n):myConnectType==CommunicationMode.USB?startSessionUSB(e,t,n):myConnectType==CommunicationMode.UART&&startSessionSerial(e,t,n)}function startSysSession(e,t,n){return myConnectType==CommunicationMode.BLUETOOTH?startSysSessionBluetooth(e,t,n):myConnectType==CommunicationMode.USB?startSysSessionUSB(e,t,n):void(myConnectType==CommunicationMode.UART&&startSysSessionSerial(e,t,n))}var pinStr,pinMode,mTradeAmount,mCurrencyCode,mCashbackAmount,mTradeType,DoTrade=function(e){writeObj(e),mListener=e,writeObj(this)},isSwitchSerial=!1,EmvOption={START:0,START_WITH_FORCE_ONLINE:1,START_WITH_FORCE_PIN:2,START_WITH_FORCE_ONLINE_FORCE_PIN:3},DoTradeMode={COMMON:0,CHECK_CARD_NO_IPNUT_PIN:1,IS_DEBIT_OR_CREDIT:2},TransactionResult={APPROVED:"APPROVED",TERMINATED:"TERMINATED",DECLINED:"DECLINED",CANCEL:"CANCEL",CAPK_FAIL:"CAPK_FAIL",NOT_ICC:"NOT_ICC",SELECT_APP_FAIL:"SELECT_APP_FAIL",DEVICE_ERROR:"DEVICE_ERROR",CARD_NOT_SUPPORTED:"CARD_NOT_SUPPORTED",MISSING_MANDATORY_DATA:"MISSING_MANDATORY_DATA",CARD_BLOCKED_OR_NO_EMV_APPS:"CARD_BLOCKED_OR_NO_EMV_APPS",INVALID_ICC_DATA:"INVALID_ICC_DATA",FALLBACK:"FALLBACK",NFC_TERMINATED:"NFC_TERMINATED",CARD_REMOVED:"CARD_REMOVED",TRADE_LOG_FULL:"TRADE_LOG_FULL",TRANSACTION_NOT_ALLOWED_AMOUNT_EXCEED:"TRANSACTION_NOT_ALLOWED_AMOUNT_EXCEED"},isNFCTrade=!1,mDoTradeMode=DoTradeMode.COMMON,mCardTmode=CardTradeMode.CardTradeMode_SWIPE_TAP_INSERT_CARD,mAmountIcon="",cDisplayStr="",mFormatId="0000",mBatchId="",mAmountPoint="",mSaveLogFlag="01",mIsSupportCashBack=!1,mPanSalt=!1,mIsSupportClsSelectEmvAPP=!1,mAmountDescribe="",FINA_CONFIRM="03",BATCH_DC="04",OFFLINE_ADVICE="05",ONLINE_ADVICE="06",REVERSAL="07",EMV_TRANS_ACCEPT="01",EMV_TRANS_DENIAL="02",EMV_TRANS_GOONLINE="03";function setAmountPoint(e){mAmountPoint=e?"01":"00"}function sendPin(e){pinMode="00",pinMode=""==(pinStr=e)||null==pinStr?"00":"01",EMVCvmSetPin(e)}function isSavelog(e){mSaveLogFlag=e?"00":"01"}function setAmount(e,t,n,r){mTradeAmount=e,mCashbackAmount=t,mCurrencyCode=n,mTradeType=toHex(r).substr(2,2)}var datas,encMode,AmountType={MONEY_TYPE_NONE:1,MONEY_TYPE_RMB:2,MONEY_TYPE_DOLLAR:3,MONEY_TYPE_CUSTOM_STR:4};function setAmountIcon(e,t){var n="";if(e==AmountType.MONEY_TYPE_NONE)n="01";else if(e==AmountType.MONEY_TYPE_RMB)n="02";else if(e==AmountType.MONEY_TYPE_DOLLAR)n="03";else if(e==AmountType.MONEY_TYPE_CUSTOM_STR)return void(null!=(mAmountIcon=t)&&""!=t&&(mAmountIcon=byteArray2Hex(getUTF8Bytes(t.trim()))));this.amountIcon=n}function setDoTradeMode(e){mDoTradeMode=e}function setFormatId(e){mFormatId=e}function setBatchId(e){mBatchId=e}function setCardTmodeMode(e){mCardTmode=e}function setPanSalt(e){mPanSalt=e}function checkAmount(e,t){var n=!0;if(null!=e&&""!=e&&0!=e.length){if("FFFFFFFF"==e)return posInputAmountFlag=!0,n;if("00000000"==e)return this.tradeAmount="",n;if("05"==t||"18"==t){if(e.startsWith("0")&&1<e.length)return mListener.onError("INPUT_INVALID"),n=!1}else if(e.startsWith("0"))return mListener.onError("INPUT_INVALID"),n=!1;-1!=e.indexOf(".")&&(mListener.onError("INPUT_INVALID_FORMAT"),n=!1)}else"05"!=t&&"18"!=t&&(mListener.onError("INPUT_INVALID"),n=!1);return n}function doTrade(e,t){10<=e||(isNFCTrade=!0,checkAmount(mTradeAmount,mTradeType)?EmvPolCard(mTradeAmount,t,mAmountIcon,e,mCardTmode,mTradeType,mCurrencyCode,cDisplayStr):mListener.onError("Input invalid"))}function EmvPolCard(e,t,n,r,a,o,s,i){var u=0,l=[],C=[],c=[],m=[],p=[],y=[],d=[],f=[],g=[],A=[],E=[],R=0,n=(isEmpty(n)||(R=(l=hexStr2Bytes(n.trim())).length),0),e=(isEmpty(e)||(n=(C=getUTF8Bytes(e.trim())).length),getFormatDateyyyyMMddHHmmss()),$=0,e=(isEmpty(e)||($=(c=hexStr2Bytes(e.trim())).length),0),i=(isEmpty(i)||(e=(m=hexStr2Bytes(i.trim())).length),0),D=(isEmpty(mFormatId)||(i=(p=hexStr2Bytes(mFormatId.trim())).length),0),P=(isEmpty(mBatchId)||(D=(y=hexStr2Bytes(mBatchId.trim())).length),0),T=(isEmpty(mAmountPoint)||(P=(d=hexStr2Bytes(mAmountPoint.trim())).length),0),S=(isEmpty(mSaveLogFlag)||(T=(f=hexStr2Bytes(mSaveLogFlag.trim())).length),0),I=(isEmpty("00")||(S=(g=hexStr2Bytes("00".trim())).length),"313431323137"),h=(I=hexStr2Bytes(I=mPanSalt?I:"")).length,O=(A=hexStr2Bytes(mIsSupportClsSelectEmvAPP?"FF01":"FF00")).length,M=1+n+1+1+R+1+1+$+1+1+1+1+1+1+2+1+e+8+1+i+1+D+1+P+1+T+1+S+1+h+1+O,b=0,M=(!isEmpty(mAmountDescribe)&&"04"==o||mIsSupportCashBack?M+=1+(b=(E=hexStr2Bytes(mAmountDescribe.trim())).length):M+=1+(b=(E=hexStr2Bytes((mAmountDescribe="303030303030").trim())).length),Array(M)),C=(M[u++]=n,arrCopyArr(C,0,M,u,n),u+=n,a==CardTradeMode.CardTradeMode_ONLY_INSERT_CARD?M[u++]=1:a==CardTradeMode.CardTradeMode_ONLY_SWIPE_CARD?M[u++]=2:a==CardTradeMode.CardTradeMode_SWIPE_TAP_INSERT_CARD?M[u++]=3:a==CardTradeMode.CardTradeMode_UNALLOWED_LOW_TRADE?M[u++]=4:a==CardTradeMode.CardTradeMode_SWIPE_INSERT_CARD?M[u++]=5:a==CardTradeMode.CardTradeMode_SWIPE_TAP_INSERT_CARD_UNALLOWED_LOW_TRADE?M[u++]=6:a==CardTradeMode.CardTradeMode_ONLY_TAP_CARD?M[u++]=7:a==CardTradeMode.CardTradeMode_SWIPE_TAP_INSERT_CARD_NOTUP?M[u++]=8:a==CardTradeMode.CardTradeMode_SWIPE_TAP_INSERT_CARD_NOTUP_UNALLOWED_LOW_TRADE?M[u++]=9:a==CardTradeMode.CardTradeMode_TAP_INSERT_CARD?M[u++]=11:a==CardTradeMode.CardTradeMode_TAP_INSERT_CARD_NOTUP?M[u++]=10:a==CardTradeMode.CardTradeMode_SWIPE_TAP_INSERT_CARD_DOWN?M[u++]=12:M[u++]=3,M[u++]=R,arrCopyArr(l,0,M,u,R),u+=R,mDoTradeMode==DoTradeMode.CHECK_CARD_NO_IPNUT_PIN?M[u++]=1:mDoTradeMode==DoTradeMode.IS_DEBIT_OR_CREDIT?M[u++]=3:M[u++]=0,M[u++]=$,arrCopyArr(c,0,M,u,$),u+=$,M[u++]=0,M[u++]=0,M[u++]=r,M[u++]=0,M[u++]=1,isEmpty(o)&&(o="01"),M[u++]=hexStr2Bytes(o)[0],3==(s=isEmpty(s)?"0156":s).length&&(s="0"+s),M[u++]=hexStr2Bytes(s)[0],M[u++]=hexStr2Bytes(s)[1],M[u++]=e,arrCopyArr(m,0,M,u,e),u+=e,M[u++]=i,arrCopyArr(p,0,M,u,p.length),u+=i,M[u++]=D,arrCopyArr(y,0,M,u,y.length),u+=D,M[u++]=P,arrCopyArr(d,0,M,u,d.length),u+=P,M[u++]=T,arrCopyArr(f,0,M,u,f.length),u+=T,M[u++]=S,arrCopyArr(g,0,M,u,g.length),u+=S,M[u++]=h,arrCopyArr(I,0,M,u,I.length),u+=h,M[u++]=b,arrCopyArr(E,0,M,u,E.length),u+=b,M[u++]=O,arrCopyArr(A,0,M,u,A.length),u+=O,calMac(M,M.length-8)),n=(arrCopyArr(C,0,M,u,8),u+=8,mListener.onRequestWaitingUser(""),CommandDownlink2(22,32,t,M),getDownPBytes());startSession(new Uint8Array(n).buffer,onReceiveDateListener,15)}function EMVCvmSetPin(e){var t,n=0,r=Array(512);r[n++]=hexStr2Bytes(pinMode)[0],e=(""==e||null==e?(r[n++]=0,r[n++]=1,r[n++]=0,arrCopyArr(r,0,t=Array(n),0,n)):(e=getUTF8Bytes(e),r[n++]=e.length,arrCopyArr(e,0,r,n,e.length),n+=e.length,r[n++]=1,r[n++]=0,arrCopyArr(r,0,t=Array(n),0,n)),CommandDownlink2(22,52,60,t),getDownPBytes()),startSession(new Uint8Array(e).buffer,onReceiveDateListener,15)}function onReceiveDateListener(e){if("01"==e.substring(18,20)&&"1620"==e.substring(8,12)){isNFCTrade=!1,mListener.onDoTradeResult(DoTradeResult.ICC,null),CommandDownlink2(22,48,60,EMVStart(EmvOption.START));var t,n=getDownPBytes();startSession(new Uint8Array(n).buffer,onReceiveDateListener,5)}else if("00"==e.substring(18,20)&&"1620"==e.substring(8,12))checkCardResult(DoTradeResult.MCR,e);else if("03"==e.substring(18,20)&&"1620"==e.substring(8,12))checkCardResult(DoTradeResult.NFC_ONLINE,e);else if("04"==e.substring(18,20)&&"1620"==e.substring(8,12))checkCardResult(DoTradeResult.NFC_OFFLINE,e);else if("05"==e.substring(18,20)&&"1620"==e.substring(8,12))mListener.onDoTradeResult(DoTradeResult.NFC_DECLINED,null);else if("02"==e.substring(18,20)&&"1620"==e.substring(8,12)){var r=parseInt(e.substring(14,18),16),a=e.substring(18,18+2*r),o=[],s=0,i=parseInt(a.substring(s,s+2),16);s+=2;for(var u=0;u<i;u++){s=s+2+2;var l=parseInt(a.substring(s,s+2),16),C=(s+=2,hex2Ascii(a.substring(s,s+2*l)));s+=2*l,o.push(C)}mListener.onRequestSelectEmvApp(o)}else if("31"==e.substring(18,20)&&"1620"==e.substring(8,12))mListener.onRequestSetPin();else if("24"==e.substring(6,8)&&"1634"==e.substring(8,12))r=parseInt(e.substring(14,18),16),continueEmvProcess(a=e.substring(18,18+2*r));else if("32"==e.substring(6,8)&&"1634"==e.substring(8,12))mListener.onRequestSetPin();else if("24"==e.substring(6,8)&&"1630"==e.substring(8,12)){if(r=parseInt(e.substring(14,18),16),a=e.substring(18,18+2*r),"02"==e.substring(12,14)){for(o=[],s=0,i=parseInt(a.substring(s,s+2),16),s+=2,u=0;u<i;u++)s=s+2+2,l=parseInt(a.substring(s,s+2),16),C=(s+=2,hex2Ascii(a.substring(s,s+2*l))),s+=2*l,o.push(C);mListener.onRequestSelectEmvApp(o)}else"31"==e.substring(12,14)||"32"==e.substring(12,14)?mListener.onRequestSetPin():continueEmvProcess(a)}else"241640"==e.substring(6,12)?(r=parseInt(e.substring(14,18),16),n=Str2Bytes(a=bufData+e.substring(18,18+2*r)),n=(r=analysisEmvResult(n))[0],t=r[1],r[2],r[3],r=r[4],n==EMV_TRANS_ACCEPT?t==REVERSAL?(mListener.onRequestDisplay(Display.REMOVE_CARD),mListener.onReturnReversalData(r),mListener.onRequestTransactionResult(TransactionResult.DECLINED)):t!=FINA_CONFIRM&&t!=BATCH_DC||(mListener.onRequestDisplay(Display.REMOVE_CARD),mListener.onRequestBatchData(r),mListener.onRequestTransactionResult(TransactionResult.APPROVED)):n==EMV_TRANS_DENIAL&&(t==ONLINE_ADVICE||t==OFFLINE_ADVICE?(mListener.onRequestDisplay(Display.REMOVE_CARD),mListener.onRequestBatchData(r),mListener.onRequestTransactionResult(TransactionResult.DECLINED)):REVERSAL==t&&(mListener.onRequestDisplay(Display.REMOVE_CARD),mListener.onReturnReversalData(r),mListener.onRequestTransactionResult(TransactionResult.DECLINED)))):"24"==e.substring(6,8)&&isSwitchSerial&&(isSwitchSerial=!1,mListener.onRturnSwitchWinusbResult(!0))}function continueEmvProcess(e){var e=analysisEmvResult(hexStr2Bytes(e)),t=e[0],n=(e[1],e[2],e[3],e[4]);EMV_TRANS_GOONLINE==t?mListener.onRequestOnlineProcess(n):emvGoOffLine(e)}function emvGoOffLine(e){var t=e[0],n=e[1],e=(e[2],e[3],e[4]);if(EMV_TRANS_DENIAL==t){if(ONLINE_ADVICE==n||OFFLINE_ADVICE==n)return mListener.onReqestDisplay(Display.REMOVE_CARD),mListener.onRequestBatchData(e),void mListener.onRequestTransactionResult(TransactionResult.DECLINED);if(REVERSAL==n)return mListener.onRequestDisplay(Display.REMOVE_CARD),mListener.onReturnReversalData(e),void mListener.onRequestTransactionResult(TransactionResult.DECLINED)}else if(EMV_TRANS_ACCEPT==t){if(REVERSAL==n)return mListener.onRequestDisplay(Display.REMOVE_CARD),mListener.onReturnReversalData(e),void mListener.onRequestTransactionResult(TransactionResult.DECLINED);if(FINA_CONFIRM==n||BATCH_DC==n)return mListener.onRequestDisplay(Display.REMOVE_CARD),mListener.onRequestBatchData(e),void mListener.onRequestTransactionResult(TransactionResult.APPROVED)}startSysSession(packageInstructionReset(),null,5)}function EMVSelectEMVApp(e){var t=[],e=(t.push(e),CommandDownlink2(22,49,60,t),getDownPBytes());isNFCTrade?startSession(new Uint8Array(e).buffer,onReceiveDateListener,15):startSysSession(new Uint8Array(e).buffer,null,60).then(function(e){var t;0==getResult()&&(t=upPLength(),continueEmvProcess(byteArray2Hex(getUpPBytes(0,t))))},function(e){})}function EMVGoOnLine(e){CommandDownlink2(22,64,30,hexStr2Bytes(e)),e=getDownPBytes(),startSession(new Uint8Array(e).buffer,onReceiveDateListener,60)}function test(e){CommandDownlink2(238,238,30,hexStr2Bytes(e)),e=getDownPBytes(),startSession(new Uint8Array(e).buffer,onReceiveDateListener,60)}function checkCardResult(e,t){var n,r,a,o=[],t=hexStr2Bytes(t.substring(14,14+t.length-16)),s=(t[2],4),i=t.length,u=t[s++],l=byteArray2Hex(getBytesFromArr(s,u,t)),u=(s+=u,o.push(l),t[s++]),l=byteArray2Hex(getBytesFromArr(s,u,t)),u=(s+=u,o.push(l),t[s++]),C=byteArray2Hex(getBytesFromArr(s,u,t)),u=(s+=u,o.push(C),t[s++]),c=ab2str(getBytesFromArr(s,u,t)),u=(s+=u,o.push(c),t[s++]),c=ab2str(getBytesFromArr(s,u,t)),u=(s+=u,o.push(c),t[s++]),c=ab2str(getBytesFromArr(s,u,t)),u=(s+=u,o.push(c),t[s++]),c=ab2str(getBytesFromArr(s,u,t)),u=(s+=u,o.push(c),t[s++]),c=ab2str(getBytesFromArr(s,u,t)),u=(s+=u,o.push(c),t[s++]),c=byteArray2Hex(getBytesFromArr(s,u,t)),u=(s+=u,o.push(c),t[s++]),c=byteArray2Hex(getBytesFromArr(s,u,t)),u=(s+=u,o.push(c),t[s++]),c=byteArray2Hex(getBytesFromArr(s,u,t)),u=(s+=u,o.push(c),s<i?(u=t[s++],r=byteArray2Hex(getBytesFromArr(s,u,t)),s+=u,o.push(r),c=t[s++],n=byteArray2Hex(getBytesFromArr(s,c,t)),s+=c,o.push(n)):n=r="","");s<i&&(c=t[s++],u=ab2str(getBytesFromArr(s,c,t)),s+=c,o.push(u)),s<i&&((r=[,])[0]=t[s++],n=byteArrayToInt(r),(c=[,])[0]=t[s++],u=byteArrayToInt(c),(r=[,])[0]=t[s++],c=byteArrayToInt(r),n.toString(),u.toString(),c.toString()),s<i?(r=t[s++],a=byteArray2Hex(getBytesFromArr(s,r,t)),s+=r):a="",o.push(a),l.toString(),C.toString(),mListener.onDoTradeResult(e,o)}function getNFCBatchData(e,t){getICCTag(1,0,"").then(function(t){0==getResult()&&(t=byteArray2Hex(getUpPBytes(0,upPLength())),e(t))},function(e){t(e)})}function getNewICCTag(e,t,n,r,a){getICCTag(e,t,n).then(function(e){0==getResult()&&(e=byteArray2Hex(getUpPBytes(0,upPLength())),r(e))},function(e){a(e)})}function getICCTagFunction(e,t,n,r,a){getICCTag(e,t,n).then(function(e){0==getResult()&&(e=byteArray2Hex(getUpPBytes(0,upPLength())),r(e))},function(e){a(e)})}function getICCTag(e,t,n){var r="00",e=(CommandDownlink2(22,81,5,hexStr2Bytes((r=(r=(r=(r+=byteArray2Hex(intToHex(e)))+byteArray2Hex(intToHex(e)))+byteArray2Hex(intToHex(t)))+(n=isEmpty(n)?"00":n)).trim())),getDownPBytes());return startSysSession(new Uint8Array(e).buffer,null,5)}function analysisEmvResult(e){var t=[];if(null==e||0==e.length)return t;var n=0,r=(n++,encMode=e[n++],[,]),r=(r[0]=e[n++],byteArray2Hex(r)),a=[,],a=(a[0]=e[n++],byteArray2Hex(a)),o=[,],o=(o[0]=e[n++],byteArrayToInt(o)),s=Array(o),i=(arrCopyArr(e,5,s,0,o),byteArray2Hex(s)),o=(n+=o,e[n++]),u=(arrCopyArr(e,n,s=Array(o),0,o),byteArray2Hex(s)),o=(n+=o,[,,]),o=(o[0]=e[n],o[1]=e[n+1],byteArrayToInt(o)),l=(arrCopyArr(e,n+=2,s=Array(o),0,o),byteArray2Hex(s)),C="";return(n+=o)<e.length&&(l=(o=2==(o=byteArray2Hex(intToHex(o))).length?"00"+o:o)+l,o=e.length-n,arrCopyArr(e,n,s=Array(o),0,o),C=byteArray2Hex(s)),l+=C,t.push(r),t.push(a),t.push(i),t.push(u),t.push(l),t}function anlysDataCommon(e,t){var n=[];if(0==encMode||16==encMode||38==encMode||48==encMode)return n.push(t),n;var t=Str2Bytes(t),r=t.length,a=0,o=[,,],o=(o[0]=t[a],o[1]=t[a+1],byteArrayToInt(o)),s=(a+=2,Array(o)),s=(arrCopyArr(t,a,s,0,o),byteArray2Hex(s));if(r<=(a+=o))return n.push(s),n;a+=2;var i,u,o=t[a++],l=Array(o),C=(arrCopyArr(t,a,l,0,o),byteArray2Hex(l)),o=(a+=o,t[a++]),c=(arrCopyArr(t,a,l=Array(o),0,o),byteArray2Hex(c)),o=(a+=o,t[a++]),m=(arrCopyArr(t,a,l=Array(o),0,o),byteArray2Hex(m)),o=(a+=o,t[a++]),p=(arrCopyArr(t,a,l=Array(o),0,o),ab2str(l)),o=(a+=o,t[a++]),y=(arrCopyArr(t,a,l=Array(o),0,o),ab2str(l)),o=(a+=o,t[a++]),d=(arrCopyArr(t,a,l=Array(o),0,o),ab2str(l)),o=(a+=o,t[a++]),f=(arrCopyArr(t,a,l=Array(o),0,o),ab2str(l)),o=(a+=o,t[a++]),g=ab2str(l),o=(a+=o,t[a++]),A=(arrCopyArr(t,a,l=Array(o),0,o),byteArray2Hex(A)),o=(a+=o,t[a++]),E=(arrCopyArr(t,a,l=Array(o),0,o),byteArray2Hex(E)),o=(a+=o,t[a++]),R=(arrCopyArr(t,a,l=Array(o),0,o),byteArray2Hex(R)),$="",D="",o=((a+=o)<r&&(o=t[a++],arrCopyArr(t,a,l=Array(o),0,o),$=byteArray2Hex(l),a+=o),a<r&&(o=t[a++],arrCopyArr(t,a,l=Array(o),0,o),D=byteArray2Hex(l),a+=o),""),P=(a<r&&(P=t[a++],arrCopyArr(t,a,l=Array(P),0,P),o=ab2str(l),a+=P),""),T="",S="",I=(a<r&&(P=t[a++]+"",T=t[a++]+"",S=t[a++]+""),""),l=(a<r&&(u=t[a++],arrCopyArr(t,a,l=Array(u),0,u),I=byteArray2Hex(l),a+=u),"");return a<r&&(u=t[a++],arrCopyArr(t,a,i=Array(u),0,u),l=byteArray2Hex(i),a+=u),a<r&&(i=t[a++],arrCopyArr(t,a,u=Array(i),0,i),byteArray2Hex(u),a+=i),n.push(p),n.push(y),n.push(d),n.push(g),n.push(f),n.push(P),n.push(T),n.push(S),n.push(C),n.push(c),n.push(m),n.push(A),n.push($),n.push(D),n.push(o),n.push(I),n.push(s),n.push(l),n.push(E),n.push(R),n}function EMVStart(e){var t=19+mTradeAmount.length+1+mCashbackAmount.length+2+1,t=Array(t),n=0,e=(e==EmvOption.START?t[n++]=0:e==EmvOption.START_WITH_FORCE_ONLINE?t[n++]=1:e==EmvOption.START_WITH_FORCE_PIN?t[n++]=2:e==EmvOption.START_WITH_FORCE_ONLINE_FORCE_PIN&&(t[n++]=3),t[n++]=hexStr2Bytes(mTradeType)[0],getFormatDateyyyyMMddHHmmss()),e=mTradeAmount.length<=8?hexStr2Bytes(e+"FF"):hexStr2Bytes(e+"06"),r=(arrCopyArr(e,0,t,n,e.length),n+=e.length,""),r=8<mTradeAmount.length?"FFFFFFFFFFFF":"FFFFFFFF",a=0,a=(isEmpty(mTradeAmount)||(a=mTradeAmount.length),arrCopyArr(e=hexStr2Bytes(r=r.substring(0,r.length-a)+mTradeAmount),0,t,n,e.length),n+=e.length,r=8<mTradeAmount.length?"":"0000",arrCopyArr(e=hexStr2Bytes(r+=mCurrencyCode=3==mCurrencyCode.length?"0"+mCurrencyCode:mCurrencyCode),0,t,n,e.length),n+=e.length,t[n++]=mTradeAmount.length+1,arrCopyArr(getUTF8Bytes(mTradeAmount),0,t,n,mTradeAmount.length),n+=mTradeAmount.length,t[n++]=0,!isEmpty(mCashbackAmount)&&0<mCashbackAmount.length?(t[n++]=byte(mCashbackAmount.length()),arrCopyArr(getUTF8Bytes(mCashbackAmount),0,t,n,mCashbackAmount.length),n+=mCashbackAmount.length):(t[n++]=1,t[n++]=48),intToHex(20));return arrCopyArr(a,0,t,n++,1),t}function onAnalyGetPinResult(e){var t,n,r,a,o,e=[];0==getResult()&&((n=2)+2<(t=upPLength())&&(a=byteArrayToInt(getUpPBytes(n,2)),n+=2),a=0,r="",(a=n+1<t?getUpPByte(n++):a)&&n+a<=t&&(r=byteArray2Hex(getUpPBytes(n,a)),n+=a),a=0,o="",(a=n+1<t?getUpPByte(n++):a)&&n+a<=t&&(o=byteArray2Hex(getUpPBytes(n,a)),n+=a),e.push(r),e.push(o)),mListener.onReturnGetPinResult(e)}DoTrade.prototype.doTrade=function(e,t){doTrade(e,t)},DoTrade.prototype.sendPin=function(e){sendPin(e)},DoTrade.prototype.doCheckCard=function(e,t){setDoTradeMode(DoTradeMode.CHECK_CARD_NO_IPNUT_PIN),doTrade(e,t)},DoTrade.prototype.selectEmvApp=function(e){EMVSelectEMVApp(e)},DoTrade.prototype.sendOnlineProcessResult=function(e){EMVGoOnLine(e)},DoTrade.prototype.testCommand=function(e){isSwitchSerial=!0,test(e)},DoTrade.prototype.setIsSupportClsSelectEmvAPP=function(e){mIsSupportClsSelectEmvAPP=e},DoTrade.prototype.getNFCBatchData=function(e,t){return getNFCBatchData(e,t)},DoTrade.prototype.getNewICCTag=function(e,t,n,r,a){return getNewICCTag(e,t,n,r,a)},DoTrade.prototype.getICCTag=function(e,t,n,r,a){return getICCTagFunction(e,t,n,r,a)},DoTrade.prototype.getPin=function(e,t,n,r,a,o,s){var i="0000",e=(i=(i=(i+=byteArray2Hex(intToHex(e)))+byteArray2Hex(intToHex(t)))+byteArray2Hex(intToHex(n)),null!=(r=asciiToHex(r))&&0!=r.length?i=i+byteArray2Hex(intToHex(r.length/2))+r:i+="00",null!=(a=asciiToHex(a))&&0!=a.length?i=i+byteArray2Hex(intToHex(a.length/2))+a:i+="00",null!=o&&0!=o.length?i=i+byteArray2Hex(intToHex(o.length/2))+o:i+="00",CommandDownlink2(16,113,s,hexStr2Bytes(i)),getDownPBytes());startSession(new Uint8Array(e).buffer,onAnalyGetPinResult,5)};var platformPos,mOperationType,EMVManager=function(e){writeObj(e),mListener=e,writeObj(this)},platformFlag=1,WRITE_MAX_LEN=(EMVManager.prototype.updateEmvAPP=function(e,t){updateEmvAPP(e,t)},EMVManager.prototype.updateEmvCAPK=function(e,t){updateEmvCAPK(e,t)},EMVManager.prototype.updateEmvConfig=function(e,t){updateEmvConfig(e,t)},EMVManager.prototype.updateEMVConfigByXml=function(e){updateEMVConfigByXml(e)},EMVManager.prototype.showEMVListOfXml=function(e){showEMVListOfXml(e)},EMVManager.prototype.updateEmvAPPByTlv=function(e,t){updateEmvAPP(e,t)},100);function updateEmvAPP(e,t){null!=e&&(isEmpty(t)&&(t=""),CommandDownlink2(23,160,15,hexStr2Bytes(updateEMV(mOperationType=e,t))),e=getDownPBytes(),startSession(new Uint8Array(e).buffer,onReturnUpdateEmvAPPResult,5))}function updateEMV(e,t){var n="";switch(e){case EMVDataOperation.CLEAR:n="01";break;case EMVDataOperation.ADD:n="02"+t;break;case EMVDataOperation.DELETE:n="03"+t;break;case EMVDataOperation.ATTAINLIST:n="04";break;case EMVDataOperation.UPDATE:n="05"+t;break;case EMVDataOperation.GETEMV:n="06"+t}return n}function onReturnUpdateEmvAPPResult(e){if(0==getResult()){if(mOperationType==EMVDataOperation.ATTAINLIST){for(var t,n=byteArray2Hex(getUpPBytes(0,upPLength())),r=n.substring(0,2),a=0;a<n.length;a++)1==n.search("1000000000000000000000000000000000")&&(t=parseInt(r,16)-1,n=n.replace("1000000000000000000000000000000000",""),r=t<17?"0"+toHex(t).substr(2,2).toUpperCase():toHex(t).substr(2,2).toUpperCase());n=r+n.slice(2),mListener.onReturnGetEMVListResult(n)}else mOperationType==EMVDataOperation.GETEMV?(e=byteArray2Hex(getUpPBytes(0,upPLength())),mListener.onReturnGetEMVListResult(e)):mOperationType==EMVDataOperation.UPDATE&&mListener.onReturnUpdateEMVResult(!0)}else mListener.onReturnUpdateEMVResult(!1);mOperationType=null}function updateEmvCAPK(e,t){null!=e&&e!=EMVDataOperation.UPDATE&&(isEmpty(t)&&(t=""),CommandDownlink2(23,161,15,hexStr2Bytes(updateEMV(mOperationType=e,t))),e=getDownPBytes(),startSession(new Uint8Array(e).buffer,onReturnUpdateEmvCAPKResult,5))}function onReturnUpdateEmvCAPKResult(e){if(0==getResult()){if(mOperationType==EMVDataOperation.ATTAINLIST){for(var t,n=byteArray2Hex(getUpPBytes(0,upPLength())),r=n.substring(0,2),a=0;a<n.length;a++)1==n.search("1000000000000000000000000000000000")&&(t=parseInt(r,16)-1,n=n.replace("1000000000000000000000000000000000",""),r=t<17?"0"+toHex(t).substr(2,2).toUpperCase():toHex(t).substr(2,2).toUpperCase());n=r+n.slice(2),mListener.onReturnGetEMVListResult(n)}else mOperationType==EMVDataOperation.GETEMV?(e=byteArray2Hex(getUpPBytes(0,upPLength())),mListener.onReturnGetEMVListResult(e)):mListener.onReturnUpdateEMVRIDResult(!0)}else mListener.onReturnUpdateEMVRIDResult(!1);mOperationType=null}var mEmvAppCfg="",mEmvCapkCfg="";function updateEmvConfig(e,t){isEmpty(e)||e.length%2!=0||isEmpty(t)||t.length%2!=0||(mOffset=0,mCustomParamString="",mCustomParam=null,mEmvAppCfg=e,mEmvCapkCfg=t,doUpdateCustomParam(CustomParam.CUSTOM_PARAM_SEG_EMV_APP,0,mEmvAppCfg))}var mCustomParam,mOffset=0,mCustomParamString="";function doUpdateCustomParam(e,t,n){mOffset=t,mCustomParam=e,t=(mCustomParamString=n).length/2,startSendCustomParam(OperationLogo.WRITE,e,t).then(function(e){if(0==getResult())return updateCustomParam()},function(e){})}function startSendCustomParam(e,t,n){var r="",e=(e==OperationLogo.READ?r+="00":r+="01",t==CustomParam.CUSTOM_PARAM_SEG_EMV_APP?r+="00":t==CustomParam.CUSTOM_PARAM_SEG_EMV_CAPK?r+="01":t==CustomParam.CUSTOM_PARAM_SEG_CUSTOM1?r+="02":t==CustomParam.CUSTOM_PARAM_SEG_CUSTOM2&&(r+="03"),n),t=e>>16&255,n=e>>8&255,a=255&e,e=(CommandDownlink2(22,144,10,hexStr2Bytes(r=(r=(r=(r+=byteArray2Hex(intToHex(e>>24)))+byteArray2Hex(intToHex(t)))+byteArray2Hex(intToHex(n)))+byteArray2Hex(intToHex(a))+"10")),getDownPBytes());return startSysSession(new Uint8Array(e).buffer,null,5)}var mUpdateCustomParamResolve=function(){},mUpdateCustomParamReject=function(){};function updateCustomParam(){var e="",t=hexStr2Bytes(mCustomParamString),n=mCustomParamString.length/2,r=mOffset,a=r>>16&255,o=r>>8&255,s=255&r,e=byteArray2Hex(intToHex(r>>24)),a=(e=(e=(e+=byteArray2Hex(intToHex(a)))+byteArray2Hex(intToHex(o)))+byteArray2Hex(intToHex(s)),s=255&(r=WRITE_MAX_LEN<(r=n-mOffset)?WRITE_MAX_LEN:r),e=(e+=byteArray2Hex(intToHex(r>>8&255)))+byteArray2Hex(intToHex(s)),Array(r)),o=(arrCopyArr(t,mOffset,a,0,r),CommandDownlink2(22,160,15,hexStr2Bytes(e+=byteArray2Hex(a))),getDownPBytes());mOffset+=r,startSession(new Uint8Array(o).buffer,onUpdateCustomParam,5)}function onUpdateCustomParam(e){0==getResult()?mOffset<(e=mCustomParamString.length/2)?updateCustomParam():stopSendCustomParam(OperationLogo.WRITE,mCustomParam):mListener.onReturnCustomConfigResult(!1,"")}function stopSendCustomParam(e,t){var n="",e=(e==OperationLogo.READ?n+="00":n+="01",t==CustomParam.CUSTOM_PARAM_SEG_EMV_APP?n+="00":t==CustomParam.CUSTOM_PARAM_SEG_EMV_CAPK?n+="01":t==CustomParam.CUSTOM_PARAM_SEG_CUSTOM1?n+="02":t==CustomParam.CUSTOM_PARAM_SEG_CUSTOM2&&(n+="03"),CommandDownlink2(22,145,15,hexStr2Bytes(n)),getDownPBytes());t==CustomParam.CUSTOM_PARAM_SEG_EMV_APP?startSysSession(new Uint8Array(e).buffer,null,5).then(function(e){doUpdateCustomParam(CustomParam.CUSTOM_PARAM_SEG_EMV_CAPK,0,mEmvCapkCfg)},function(e){}):(startSysSession(new Uint8Array(e).buffer,null,5),mListener.onReturnCustomConfigResult(!0,""),mConfig="")}function stopSendCustomParam2(e,t){var n="",e=(e!=OperationLogo.READ&&(n+="01"),t==CustomParam.CUSTOM_PARAM_SEG_EMV_APP?n+="00":t==CustomParam.CUSTOM_PARAM_SEG_EMV_CAPK?n+="01":t==CustomParam.CUSTOM_PARAM_SEG_CUSTOM1?n+="02":t==CustomParam.CUSTOM_PARAM_SEG_CUSTOM2&&(n+="03"),CommandDownlink2(22,145,10,hexStr2Bytes(n)),getDownPBytes());return startSysSession(new Uint8Array(e).buffer,null,5)}var mConfig,OperationLogo={READ:0,WRITE:1},CustomParam={CUSTOM_PARAM_SEG_CUSTOM1:0,CUSTOM_PARAM_SEG_CUSTOM2:1,CUSTOM_PARAM_SEG_EMV_APP:2,CUSTOM_PARAM_SEG_EMV_CAPK:3},appOrCapkList=[];function showEMVListOfXml(e){if(null==(mConfig=analyseEMVData(e))||mConfig.length<1)mListener.onReturnCustomConfigResult(!1,"xml file is empty");else{for(var t in mConfig)appOrCapkList.push(getAppOrCapk(mConfig[t].type,mConfig[t].data));mListener.onReturnShowEMVOfXml(appOrCapkList),appOrCapkList.length=0}}function updateEMVConfigByXml(e){null==(mConfig=analyseEMVData(e))||mConfig.length<1?mListener.onReturnCustomConfigResult(!1,"xml file is empty"):judgePlatform().then(function(e){if(0==getResult()){var t=0,t=hex2Ascii(byteArray2Hex(getUpPBytes(1,getUpPByte(+t))));(platformPos="4.0"<=t?1:0)==platformFlag&&checkConfigContent(mConfig,platformPos)}},function(e){})}function analyseEMVData(e){if(platformFlag=1,null!=e){for(var t,n=e.split("\\n"),r=[],a="",o=[],s=0;s<n.length;s++)-1==(t=n[s]).search("<")||t.trim().startsWith("<!--")||(-1!=t.search("app")&&-1!=a.search("app")&&0!=o.length&&(r.push(generateAppOrCapk(0,o)),o.length=0),-1!=t.search("capk")&&-1!=a.search("app")&&0!=o.length&&(r.push(generateAppOrCapk(0,o)),o.length=0),-1!=t.search("capk")&&-1!=a.search("capk")&&0!=o.length&&(r.push(generateAppOrCapk(1,o)),o.length=0),-1==t.search("app")&&-1==t.search("capk")&&o.push(parseLine(t)),a=t);return 0!=o.length&&r.push(generateAppOrCapk(1,o)),r}}function generateAppOrCapk(e,t){var n,r="",e=0==e?"APP":"CAPK";for(n in t)r+=t[n];return new resolvableInterface(e,r)}function getAppOrCapk(e,t){var n=t.search("9F06"),r=2*parseInt(t.substring(n+4,n+4+2)),a=t.substring(n+4+2,n+4+2+r);return"APP"==e?new appOrCapkInterface(e,a,null):(n=t.search("9F22"),r=2*parseInt(t.substring(n+4,n+4+2)),t=t.substring(n+4+2,n+4+2+r),new appOrCapkInterface(e,a,t))}function parseLine(e){var t=e.indexOf(">"),n=e.indexOf("<"),r=e.indexOf("<",t),n=e.substring(n+1,t);if("DF72"==n.toUpperCase()&&(platformFlag=0),"9F73"==n.toUpperCase())return"";var a,o,e=e.substring(t+1,r),t=e.length/2,r=t.toString(16);return t<128?r.length%2==1&&(r="0"+r):128<=t&&t<256?r="81"+(r=r.length%2==1?"0"+r:r):256<=t&&t<65536?((o=(t>>8&255).toString(16)).length%2==1&&(o="0"+o),r="82"+(r=r.length%2==1?o+"0"+r:r)):65536<=t&&t<16777216&&(a=(t>>16&255).toString(16),o=(t>>8&255).toString(16),a.length%2==1&&(a="0"+a),o.length%2==1&&(o="0"+o),r="83"+(r=r.length%2==1?a+o+"0"+r:r)),n+r+e}var resolvableInterface=function(e,t){this.type=e,this.data=t},appOrCapkInterface=function(e,t,n){this.type=e,this.id=t,this.index=n};function judgePlatform(){CommandDownlink(17,48,5);var e=getDownPBytes();return startSysSession(new Uint8Array(e).buffer,null,5)}var totalCount=0,aidByteCount=0,capkByteCount=0,aidByteCountSize=0,capkByteCountSize=0;function checkConfigContent(e,t){for(var n in capkByteCountSize=aidByteCountSize=capkByteCount=aidByteCount=totalCount=0,e)"APP"==e[n].type?aidByteCount++:"CAPK"==e[n].type&&capkByteCount++;if(1==t){if(24576<(totalCount=(aidByteCountSize=384*aidByteCount)+(capkByteCountSize=384*capkByteCount)))return}else if(32768<(totalCount=(aidByteCountSize=670*aidByteCount)+(capkByteCountSize=288*capkByteCount)))return;sendAppAndCapkSizeToPos(aidByteCountSize,CustomParam.CUSTOM_PARAM_SEG_EMV_APP)}function sendAppAndCapkSizeToPos(e,t){startSendCustomParam(OperationLogo.WRITE,t,e).then(function(e){0==getResult()&&stopSendCustomParam2(OperationLogo.WRITE,t).then(function(e){getResult(),t==CustomParam.CUSTOM_PARAM_SEG_EMV_APP?sendAppAndCapkSizeToPos(capkByteCountSize,CustomParam.CUSTOM_PARAM_SEG_EMV_CAPK):t==CustomParam.CUSTOM_PARAM_SEG_EMV_CAPK&&(emvRsult=(capkCleFlag=appCleFlag=!1,!0),msg=new String,updateEmvCOnfigRunnable(mConfig,0))},function(e){})},function(e){})}var appCleFlag=!1,capkCleFlag=!1,emvRsult=!0,msg=new String;function updateEmvCOnfigRunnable(e,t){t<e.length?("APP"==e[t].type&&(appCleFlag?updateEmvAPP2(EMVDataOperation.ADD,e[t].data).then(function(n){var r;if(0!=getResult())return emvRsult=!1,r=e[t].data.substring(4,6),msg=msg+"AID:"+(r=e[t].data.substring(6,5+r))+"fail",mListener.onReturnCustomConfigResult(emvRsult,msg.toString()),mConfig="",!0;updateEmvCOnfigRunnable(e,++t)},function(e){}):updateEmvAPP2(EMVDataOperation.CLEAR,"").then(function(n){0==getResult()?(appCleFlag=!0,updateEmvAPP2(EMVDataOperation.ADD,e[t].data).then(function(n){var r;if(0!=getResult())return emvRsult=!1,r=e[t].data.substring(4,6),msg=msg+"AID:"+(r=e[t].data.substring(6,5+r))+"fail",mListener.onReturnCustomConfigResult(emvRsult,msg.toString()),mConfig="",!0;updateEmvCOnfigRunnable(e,++t)},function(e){})):(emvRsult=!1,msg+="AID clean fail",mListener.onReturnCustomConfigResult(emvRsult,msg.toString()),mConfig="")},function(e){})),"CAPK"==e[t].type&&(capkCleFlag?updateEmvCAPK2(EMVDataOperation.ADD,e[t].data).then(function(n){var r;if(0!=getResult())return emvRsult=!1,r=e[t].data.substring(4,6),msg=msg+"capk:"+(r=e[t].data.substring(6,5+r))+"fail",mListener.onReturnCustomConfigResult(emvRsult,msg.toString()),mConfig="",!0;updateEmvCOnfigRunnable(e,++t)},function(e){}):updateEmvCAPK2(EMVDataOperation.CLEAR,"").then(function(n){0==getResult()?(capkCleFlag=!0,updateEmvCAPK2(EMVDataOperation.ADD,e[t].data).then(function(n){var r;if(0!=getResult())return emvRsult=!1,r=e[t].data.substring(4,6),msg=msg+"capk:"+(r=e[t].data.substring(6,5+r))+"fail",mListener.onReturnCustomConfigResult(emvRsult,msg.toString()),mConfig="",!0;updateEmvCOnfigRunnable(e,++t)},function(e){})):(emvRsult=!1,msg+="CAPK clean fail",mListener.onReturnCustomConfigResult(emvRsult,msg.toString()),mConfig="")},function(e){}))):(mListener.onReturnCustomConfigResult(emvRsult,msg.toString()),mConfig="")}function updateEmvAPP2(e,t){if(null!=e&&e!=EMVDataOperation.UPDATE)return CommandDownlink2(23,160,15,hexStr2Bytes(updateEMV(mOperationType=e,t))),e=getDownPBytes(),startSysSession(new Uint8Array(e).buffer,null,5)}function updateEmvCAPK2(e,t){if(null!=e&&e!=EMVDataOperation.UPDATE)return CommandDownlink2(23,161,15,hexStr2Bytes(updateEMV(mOperationType=e,t))),e=getDownPBytes(),startSysSession(new Uint8Array(e).buffer,null,5)}var mParas,GetMifareCardInfo=function(e){writeObj(e),mListener=e,writeObj(this)};function pollOnMifareCard(e){doMifareCard("01",e)}function finishMifareCard(e){doMifareCard("0E",e)}function doMifareCard(e,t){CommandDownlink2(23,128,t,hexStr2Bytes(mParas=e)),e=getDownPBytes(),startSession(new Uint8Array(e).buffer,onSearchMifareCardResult,t)}function onSearchMifareCardResult(e){var t,n,r,a,o,s,i,u,e=1;0==getResult()?"01"==mParas?(u=intToHexValue(getUpPBytes(e++,1)),i=intToHexValue(getUpPBytes(e++,1)),t=byteArray2Hex(getUpPBytes(e,2)),n=byteArray2Hex(getUpPBytes(e+=2,1)),e+=1,r=getUpPBytes(e++,1),a=byteArray2Hex(getUpPBytes(e,r)),e+=r,s="",0!=(o=getUpPBytes(e++,1))&&(s=byteArray2Hex(getUpPBytes(e,o))),(i={cardType:i,ATQA:t,SAK:n,cardUidLen:r+"",cardUid:a,cardAtsLen:o+"",cardAts:s}).status="00"==u?"poll card success!":"poll card fail!",mListener.onSearchMifareCardResult(i)):"0E"==mParas&&("00"==(u=intToHexValue(getUpPBytes(e++,1)))?mListener.onFinishMifareCardResult(!0):mListener.onFinishMifareCardResult(!1)):64==getResult()?mListener.onSearchMifareCardCanceled():("01"==mParas&&mListener.onSearchMifareCardResult(null),"0E"==mParas&&mListener.onFinishMifareCardResult(!1))}GetMifareCardInfo.prototype.pollOnMifareCard=function(e){pollOnMifareCard(e)},GetMifareCardInfo.prototype.finishMifareCard=function(e){finishMifareCard(e)};var getPosInfo=function(e){writeObj(e),mListener=e,writeObj(this)};function getQPosInfo(){CommandDownlink(17,48,5);var e=getDownPBytes();startSession(new Uint8Array(e).buffer,onQposInfoResult,5)}function onQposInfoResult(e){0==getResult()&&anlycPosInfo()}function getQPosId(){CommandDownlink(16,0,5);var e=getDownPBytes();startSession(new Uint8Array(e).buffer,onQposIdResult,5)}function onQposIdResult(e){0==getResult()&&anlycPosId()}function setShutDownTime(e){65535<e||(CommandDownlink2(32,208,5,intToHex(e)),e=getDownPBytes(),startSession(new Uint8Array(e).buffer,onSetShutDownTime,5))}function onSetShutDownTime(e){getResult()}function getShutDownTime(){CommandDownlink(32,224,5);var e=getDownPBytes();startSession(new Uint8Array(e).buffer,onGetShutDownTime,5)}function onGetShutDownTime(e){0==getResult()&&(e=byteArray2Hex(getUpPBytes(0,upPLength())))}function setSleepModeTime(e){if(!(4294967295<e)){var t=intToHex(e),n=[,,,,];switch(t.length){case 1:n[0]=0,n[1]=0,n[2]=0,n[3]=t[0];break;case 2:n[0]=0,n[1]=0,n[2]=t[0],n[3]=t[1];break;case 3:n[0]=0,n[1]=t[0],n[2]=t[1],n[3]=t[2];break;case 4:n=t}CommandDownlink2(34,112,5,n),e=getDownPBytes(),startSession(new Uint8Array(e).buffer,onSetSleepModeTime,5)}}function onSetSleepModeTime(e){getResult()}function getSleepModeTime(){CommandDownlink(34,128,10);var e=getDownPBytes();startSession(new Uint8Array(e).buffer,onGetSleepModeTime,5)}function onGetSleepModeTime(e){getResult()}function onSetBuzzerResult(e){0==getResult()?mListener.onSetBuzzerResult(!0):mListener.onSetBuzzerResult(!1)}getPosInfo.prototype.doSetBuzzerOperation=function(e){var t=e+"",e=(CommandDownlink2(23,144,10,hexStr2Bytes(t=0<=e&&e<10?"00C80"+t:"00C8"+t)),getDownPBytes());startSession(new Uint8Array(e).buffer,onSetBuzzerResult,5)};var do_trade_timeout,mName,keyManager=function(e){writeObj(e),mListener=e,writeObj(this)},isLcdClosed=!1,isLcdshowing=!1,lcdShowCustomDisplayStr="",LcdModeAlign={LCD_MODE_ALIGNLEFT:1,LCD_MODE_ALIGNRIGHT:2,LCD_MODE_ALIGNCENTER:3},CustomInputOperateType={isNumber:1,Other:2},CustomInputDisplayType={PlainText:1,Other:2};function doInputCustomStr(e,t,n,r,a,o){mName=a,a="0000",e==CustomInputOperateType.isNumber?a+="00":a+="01",e==CustomInputDisplayType.PlainText?a+="01":a+="00",CommandDownlink2(16,192,o,hexStr2Bytes(a=(a=(a+=intToHexValue(n))+intToHexValue(r.length+1))+r+"00")),e=getDownPBytes(),startSession(new Uint8Array(e).buffer,onReturnDoInputCustomStr,o)}function onReturnDoInputCustomStr(e){var t;0==getResult()?(t=(e=hexStr2Bytes(e.substring(18,e.length-2)))[2],t=byteArray2Hex(getBytesFromArr(3,t,e)),mListener.onReturnDoInputCustomStr(hex2Ascii(t),mName)):mListener.onReturnDoInputCustomStr(null,mName)}function lcdShowCustomDisplay(e,t,n){isLcdshowing&&lcdShowCloseDisplay(),isLcdClosed=(isLcdshowing=!0,!1),do_trade_timeout=n,n="00",n=e==LcdModeAlign.LCD_MODE_ALIGNLEFT?"00":e==LcdModeAlign.LCD_MODE_ALIGNRIGHT?"20":e==LcdModeAlign.LCD_MODE_ALIGNCENTER?"40":"00",null==e&&(n="80"),e=hexStr2Bytes(lcdShowCustomDisplayStr=null!=t&&""!=t?n+t+"00":""),CommandDownlink2(65,16,do_trade_timeout,e),n=getDownPBytes(),startSession(new Uint8Array(n).buffer,onLcdShowCustomDisplay,do_trade_timeout)}function onLcdShowCustomDisplay(e){var t;0==getResult()?(t=new Date,setTimeout(function(){isLcdshowing=!1,isLcdClosed||mListener.onLcdShowCustomDisplay(!0)},1e3*do_trade_timeout)):mListener.onLcdShowCustomDisplay(!1)}function lcdShowCloseDisplay(){var e;isLcdshowing&&(CommandDownlink2(65,16,1,hexStr2Bytes(lcdShowCustomDisplayStr="")),e=getDownPBytes(),isLcdshowing=(isLcdClosed=!0,!1),startSession(new Uint8Array(e).buffer,onLcdShowCustomDisplay,do_trade_timeout))}function setMasterKey(e,t,n,r){10<n||(CommandDownlink2(16,226,r,hexStr2Bytes(e+t+"0"+n)),r=getDownPBytes(),startSession(new Uint8Array(r).buffer,onSetMasterKeyResult,5))}function onSetMasterKeyResult(e){0==getResult()?mListener.onReturnSetMasterKeyResult(!0):mListener.onReturnSetMasterKeyResult(!1)}function udpateWorkKey(e,t,n,r,a,o,s,i){10<=s||(CommandDownlink2(16,240,i,hexStr2Bytes(setWorkKeyStr(e,t,n,r,a,o,s))),i=getDownPBytes(),startSession(new Uint8Array(i).buffer,onUpdateWorkKeyResult,5))}function setWorkKeyStr(e,t,n,r,a,o,s){var i="",u=0,u=(isEmpty(e)||isEmpty(t)?t=e="":(u=e.length+t.length,u/=2),i+=toHex(u).substr(2,2)+e+t,0),e=(isEmpty(n)||isEmpty(r)?r=n="":(u=n.length+r.length,u/=2),i+=toHex(u).substr(2,2)+n+r,0);return isEmpty(a)||isEmpty(o)?o=a="":(e=a.length+o.length,e/=2),(i+=toHex(e).substr(2,2)+a+o)+"0"+s}function onUpdateWorkKeyResult(e){0==getResult()?mListener.onRequestUpdateWorkKeyResult(!0):mListener.onRequestUpdateWorkKeyResult(!1)}function doUpdateIPEKOperation(e,t,n,r,a,o,s,i,u,l){10<=e||(CommandDownlink2(16,242,5,hexStr2Bytes("00000"+e+t+n+r+a+o+s+i+u+l)),e=getDownPBytes(),startSession(new Uint8Array(e).buffer,onUpdateIPEKResult,5))}function onUpdateIPEKResult(e){0==getResult()?mListener.onReturnUpdateIPEKResult(!0):mListener.onReturnUpdateIPEKResult(!1)}keyManager.prototype.setMasterKey=function(e,t,n,r){setMasterKey(e,t,n,r)},keyManager.prototype.udpateWorkKey=function(e,t,n,r,a,o,s,i){udpateWorkKey(e,t,n,r,a,o,s,i)},keyManager.prototype.udpateWorkKey=function(e,t,n,r,a,o,s,i){udpateWorkKey(e,t,n,r,a,o,s,i)},keyManager.prototype.doInputCustomStr=function(e,t,n,r,a,o){doInputCustomStr(e,t,n,r,a,o)},keyManager.prototype.lcdShowCustomDisplay=function(e,t,n){lcdShowCustomDisplay(e,t,n)},keyManager.prototype.lcdShowCloseDisplay=function(){lcdShowCloseDisplay()},keyManager.prototype.doUpdateIPEKOperation=function(e,t,n,r,a,o,s,i,u,l){doUpdateIPEKOperation(e,t,n,r,a,o,s,i,u,l)};var NfcApdu=function(e){writeObj(e),mListener=e,writeObj(this)};function onApduResult(e){var t,n,r;0!=getResult()||(e=0)==(t=getUpPByte(e++))?mListener.onReturnApduResult(!1,null,0):(n=getUpPByte(e++),e=getUpPByte(e++),17==t&&(n+=255,e+=255),r=byteArray2Hex(getUpPBytes(3,e)),mListener.onReturnApduResult(!0,r,n))}function onReturnPowerOffNFCResult(e){0==getResult()?mListener.onReturnPowerOffNFCResult(!0):mListener.onReturnPowerOffNFCResult(!1)}function onPowerOnNFCResult(e){var t,n,r,a;0!=getResult()||(e=0)==(t=getUpPByte(e++))?mListener.onReturnPowerOnNFCResult(!1,null,null,0):(n=byteArray2Hex(getUpPBytes(1,10)),e+=10,r=getUpPByte(e++),a=byteArray2Hex(getUpPBytes(13,e=getUpPByte(e++))),mListener.onReturnPowerOnNFCResult(!0,n,a,r))}NfcApdu.prototype.sendApduByNFC=function(e,t){e=hexStr2Bytes(e),CommandDownlink2(23,16,t,e),t=getDownPBytes(),startSession(new Uint8Array(t).buffer,onApduResult,5)},NfcApdu.prototype.powerOffNFC=function(e){CommandDownlink(23,32,e),e=getDownPBytes(),startSession(new Uint8Array(e).buffer,onReturnPowerOffNFCResult,5)},NfcApdu.prototype.powerOnNFC=function(e){CommandDownlink2(23,0,e,hexStr2Bytes("00")),e=getDownPBytes(),startSession(new Uint8Array(e).buffer,onPowerOnNFCResult,5)};var TCKEY=[0,0,0,0,0,0,0,0],dataLen=0,HEADER_LEN=4,CRC_LEN=1,OVERHEAD_LEN=5,DATA_FIELD_HEADER_LEN=5,bytes=[];function packet(e){(bytes=Array(e=OVERHEAD_LEN+DATA_FIELD_HEADER_LEN+(dataLen=e)))[1]=0,1==(e=intToHex(e-4)).length?bytes[2]=e[0]:(bytes[1]=e[0],bytes[2]=e[1]),bytes[0]=77}function packet2(e){arrCopyArr(e,0,bytes=Array(e.length),0,e.length),dataLen=e.length-(OVERHEAD_LEN+DATA_FIELD_HEADER_LEN)}function setPByte(e,t){bytes[HEADER_LEN+e]=t}function getPByte(e){return e+HEADER_LEN<bytes.length?bytes[e+HEADER_LEN]:0}function getPBytes(){return bytes}function setCmdID(e){bytes[3]=e}function getCmdID(){return bytes[3]}function setCmdCode(e){setPByte(0,e)}function setCmdSubCode(e){setPByte(1,e)}function getCmdCode(){return getPByte(0)}function getCmdSubCode(){return getPByte(1)}function getResultCode(){return getPByte(2)}function setDataField(e){var t=e.length,t=(setPByte(3,0),intToHex(t));1==t.length?setPByte(4,t[0]):(setPByte(3,t[0]),setPByte(4,t[1])),arrCopyArr(e,0,bytes,HEADER_LEN+5,e.length)}function getDataFieldByte(e){return e+HEADER_LEN+5<bytes.length?bytes[e+HEADER_LEN+5]:0}function setTimeOut(e){setPByte(2,e)}function setPCRC(e){bytes[bytes.length-1]=e}function buildCRC(){setPCRC(calPCRC(bytes))}function getPCRC(){return bytes[bytes.length-1]}function calPCRC(e){for(var t=e[0],n=1;n<e.length-1;n++)t^=e[n];return t}function validPCRC(){return calPCRC(bytes)==getPCRC()}function isValid(){return 77==bytes[0]&&validPCRC()}function isPEmpty(){return 0==dataLen}function len(){return dataLen}function setDesKey(){if(8==KEY.length)arrCopyArr(KEY,0,TCKEY,0,8);else if(16==KEY.length){for(var e=Array(8),t=0;t<8;t++)e[t]=byte(KEY[t]^KEY[t+8]);arrCopyArr(e,0,TCKEY,0,8)}}function calMac(e,t){var n=t+1+(8-(t+1)%8),r=Array(n);arrCopyArr(e,0,r,0,t);for(var a=t;a<n;a++)r[a]=0;for(var o=[0,0,0,0,0,0,0,0],a=0;a<n;a++)o[a%8]=o[a%8]^r[a];return o}var pinOperation=function(e){writeObj(e),mListener=e,writeObj(this)};function setInputCsutomStr(e,t,n,r,a){doGetPin(e,t,n,r,"","",0,a)}function getPin(e,t,n,r,a,o,s){doGetPin(e,t,n,r,a,o,0,s)}function doGetPin(e,t,n,r,a,o,s,i){var u="0000";u+=byteArray2Hex(intToHex(e))+byteArray2Hex(intToHex(t))+byteArray2Hex(intToHex(n)),isEmpty(r)?(r="",u+=byteArray2Hex(intToHex(0))+r):u+=byteArray2Hex(intToHex(getUTF8Bytes(r).length+1))+byteArray2Hex(toGbkBytes(r))+"00",isEmpty(r)?(a="",u+=byteArray2Hex(intToHex(0))+a):u+=byteArray2Hex(intToHex(a.length))+byteArray2Hex(getUTF8Bytes(a)),isEmpty(r)?(o="",u+=byteArray2Hex(intToHex(0))+o):u+=byteArray2Hex(intToHex(o.length/2))+o,CommandDownlink2(16,113,i,hexStr2Bytes(u+=byteArray2Hex(intToHex(s)))),e=getDownPBytes(),startSession(new Uint8Array(e).buffer,onReturnGetPinResult,5)}function onReturnGetPinResult(e){var t,n,r,a;0==getResult()?(e=[],upPLength(),byteArray2Hex(getUpPBytes(t=2,2)),t+=2,n=byteArray2Hex(getUpPBytes(5,r=getUpPByte(t++))),t+=r,r=getUpPByte(t++),a=byteArray2Hex(getUpPBytes(t,r)),t+=r,e.push(n),e.push(a),mListener.onReturnGetPinResult(e)):mListener.onReturnGetPinResult(null)}function pinKey_TDES(e,t,n,r){var a;isEmpty(t)||(a="0000",a=(a+=byteArray2Hex(intToHex(e))+t)+byteArray2Hex(intToHex(r)),CommandDownlink2(17,32,n,hexStr2Bytes(a)),e=getDownPBytes(),startSession(new Uint8Array(e).buffer,onPinKey_TDES_Result,5))}function onPinKey_TDES_Result(e){0==getResult()&&byteArray2Hex(getAllBytes())}pinOperation.prototype.setInputCsutomStr=function(e,t,n,r){setInputCsutomStr("0",e,t,n,r)};var READ_BUF_MAX_SIZE=10240,dataBuffer=new ArrayBuffer(READ_BUF_MAX_SIZE),dataView=new DataView(dataBuffer),read_offset=0;function clearReadbuffer(){for(var e=0;e<read_offset;e++)dataView.setUint8(e,0);read_offset=0}function appendData(e){for(var t=e,n=0;n<t.byteLength;n++)dataView.setUint8(read_offset,t.getUint8(n)),read_offset++}function readBufferData(){var e=new ArrayBuffer(read_offset),t=new DataView(e);return copyArr(dataBuffer,0,e,0,read_offset),t}function isCompleteInstruction(){var e,t,n=!1;return 77==dataView.getUint8(0)&&((e=dataView.getUint8(1))-e%16)/16*4096+e%16*256+(t=dataView.getUint8(2))+4<=read_offset&&(n=!0),n}var QPOSAnalyResult=function(e){writeObj(e),mListener=e,writeObj(this)};function onAnalyQposInfoResult(e){0==getResult()&&(e=anlycPosInfo(),writeObj(this),mListener.onQposInfoResult(e))}function onAnalyQposIdResult(e){0==getResult()&&(e=anlycPosId(),mListener.onQposIdResult(e))}QPOSAnalyResult.prototype.getQPosId=function(){CommandDownlink(16,0,5);var e=getDownPBytes();startSession(new Uint8Array(e).buffer,onAnalyQposIdResult,5)},QPOSAnalyResult.prototype.getQPosInfo=function(){CommandDownlink(17,48,5);var e=getDownPBytes();startSession(new Uint8Array(e).buffer,onAnalyQposInfoResult,5)},QPOSAnalyResult.prototype.checkCmdId=function(){return checkCmdId()};var Display={TRY_ANOTHER_INTERFACE:"TRY_ANOTHER_INTERFACE",PLEASE_WAIT:"PLEASE_WAIT",REMOVE_CARD:"REMOVE_CARD",CLEAR_DISPLAY_MSG:"CLEAR_DISPLAY_MSG",PROCESSING:"PROCESSING",PIN_OK:"PIN_OK",TRANSACTION_TERMINATED:"TRANSACTION_TERMINATED",INPUT_PIN_ING:"INPUT_PIN_ING",MAG_TO_ICC_TRADE:"MAG_TO_ICC_TRADE",INPUT_OFFLINE_PIN_ONLY:"INPUT_OFFLINE_PIN_ONLY",CARD_REMOVED:"CARD_REMOVED",INPUT_LAST_OFFLINE_PIN:"INPUT_LAST_OFFLINE_PIN",MSR_DATA_READY:"MSR_DATA_READY"};function checkCmdId(){var e=!1,t=commandID();return t==CmdId.CMDID_COMPLETED||t==CmdId.CMDID_COMPLETED_ENCRY?e=!0:t==CmdId.CMDID_INPUT_PIN_ING?(e=!0,0<upPLength()&&0!=getUpPByte(0)?mListener.onRequestDisplay(Display.INPUT_OFFLINE_PIN_ONLY):mListener.onRequestDisplay(Display.INPUT_PIN_ING)):t==CmdId.CMDID_MAG_TO_ICC_TRADE?(e=!0,mListener.onRequestDisplay(Display.MAG_TO_ICC_TRADE)):t==CmdId.CMDID_SEND_IC_CARDNO||t==CmdId.CMDID_EMV_KERNEL_PC||t==CmdId.CMDID_CHECK_HAVE_CARD?e=!0:t==CmdId.CMDID_MSR_DATA_READY?(e=!0,mListener.onRequestDisplay(Display.MSR_DATA_READY)):(e=!1,t==CmdId.CMDID_DESTRUCT?mListener.onRequestTransactionResult(TransactionResult.DEVICE_ERROR):t==CmdId.CMDID_TIMEOUT?mListener.onError(POSError.CMD_TIMEOUT):t==CmdId.CMDID_CARD_REMOVED?mListener.onRequestDisplay(Display.CARD_REMOVED):t==CmdId.CMDID_USERCANCEL?(mListener.onRequestDisplay(Display.TRANSACTION_TERMINATED),mListener.onRequestTransactionResult(TransactionResult.CANCEL)):t==CmdId.CMDID_MACERROR?mListener.onError(POSError.MAC_ERROR):t==CmdId.CMDID_EMV_TRANS_DENIAL?(mListener.onEmvICCExceptionData(byteArray2Hex(getUpPBytes(0,upPLength()))),mListener.onRequestTransactionResult(TransactionResult.DECLINED)):t==CmdId.CMDID_EMV_TRANS_TERMINATE?(mListener.onRequestDisplay(Display.TRANSACTION_TERMINATED),mListener.onEmvICCExceptionData(byteArray2Hex(getUpPBytes(0,upPLength()))),mListener.onRequestTransactionResult(TransactionResult.TERMINATED)):t==CmdId.CMDID_EMV_TRANS_TERMINATE_NFC?mListener.onRequestTransactionResult(TransactionResult.NFC_TERMINATED):t==CmdId.CMDID_NOT_AVAILABLE||t==CmdId.CMDID_OLD?mListener.onError(POSError.CMD_NOT_AVAILABLE):t==CmdId.CMDID_RESET?(e=!0,mListener.onError(POSError.DEVICE_RESET)):t==CmdId.CMDID_ICC_POWER_ON_ERROR?mListener.onDoTradeResult(DoTradeResult.NOT_ICC,null):t==CmdId.CMDID_WR_DATA_ERROR?mListener.onError(POSError.WR_DATA_ERROR):t==CmdId.CMDID_EMV_APP_CFG_ERROR?mListener.onError(POSError.EMV_APP_CFG_ERROR):t==CmdId.CMDID_EMV_CAPK_CFG_ERROR?mListener.onError(POSError.EMV_CAPK_CFG_ERROR):t==CmdId.CMDID_NO_UPDATE_WORK_KEY?mListener.onDoTradeResult(DoTradeResult.NO_UPDATE_WORK_KEY,null):t==CmdId.CMDID_EMV_TRANS_CARD_BLOCKED_OR_EMV_APPS?mListener.onRequestTransactionResult(TransactionResult.CARD_BLOCKED_OR_NO_EMV_APPS):t==CmdId.CMDID_EMV_TRANS_SELECT_APP_FAILED?mListener.onRequestTransactionResult(TransactionResult.SELECT_APP_FAIL):t==CmdId.CMDID_EMV_TRANS_CAPK_FAILED?mListener.onRequestTransactionResult(TransactionResult.CAPK_FAIL):t==CmdId.CMDID_EMV_TRANS_FALLBACK?mListener.onRequestTransactionResult(TransactionResult.FALLBACK):t==CmdId.CMDID_EMV_TRANS_TRY_ANOTHER_INTERFACE?mListener.onDoTradeResult(DoTradeResult.TRY_ANOTHER_INTERFACE,null):(t==CmdId.CMDID_ICC_INIT_ERROR||CmdId.CMDID_ICC_TRADE_ERROR,mListener.onError(POSError.UNKNOWN))),e}var connectionId,POSError={TIMEOUT:"TIMEOUT",MAC_ERROR:"MAC_ERROR",CMD_TIMEOUT:"CMD_TIMEOUT",CMD_NOT_AVAILABLE:"CMD_NOT_AVAILABLE",DEVICE_RESET:"DEVICE_RESET",UNKNOWN:"UNKNOWN",DEVICE_BUSY:"DEVICE_BUSY",INPUT_OUT_OF_RANGE:"INPUT_OUT_OF_RANGE",INPUT_INVALID_FORMAT:"INPUT_INVALID_FORMAT",INPUT_ZERO_VALUES:"INPUT_ZERO_VALUES",INPUT_INVALID:"INPUT_INVALID",CASHBACK_NOT_SUPPORTED:"CASHBACK_NOT_SUPPORTED",CRC_ERROR:"CRC_ERROR",COMM_ERROR:"COMM_ERROR",WR_DATA_ERROR:"WR_DATA_ERROR",EMV_APP_CFG_ERROR:"EMV_APP_CFG_ERROR",EMV_CAPK_CFG_ERROR:"EMV_CAPK_CFG_ERROR",APDU_ERROR:"APDU_ERROR",APP_SELECT_TIMEOUT:"APP_SELECT_TIMEOUT",ICC_ONLINE_TIMEOUT:"ICC_ONLINE_TIMEOUT",AMOUNT_OUT_OF_LIMIT:"AMOUNT_OUT_OF_LIMIT"},DoTradeResult={NONE:"NONE",MCR:"MCR",ICC:"ICC",NOT_ICC:"NOT_ICC",BAD_SWIPE:"BAD_SWIPE",NO_RESPONSE:"NO_RESPONSE",NO_UPDATE_WORK_KEY:"NO_UPDATE_WORK_KEY",NFC_ONLINE:"NFC_ONLINE",NFC_OFFLINE:"NFC_OFFLINE",NFC_DECLINED:"NFC_DECLINED",TRY_ANOTHER_INTERFACE:"TRY_ANOTHER_INTERFACE"},QPOSService=function(e){this.mOnResult,this.mDoTrade,this.mWebBluetooth,this.mEMVManager,this.writeChar,this.mKeyManager,this.mUpdateFirmware,this.mGtMifareCardInfo,this.mpinOperation,this.mNfcApdu,this.mgetPosInfo},SerialManager=(QPOSService.prototype.initListener=function(e){this.mOnResult=new QPOSAnalyResult(e),this.mDoTrade=new DoTrade(e),this.mWebBluetooth=new webBluetooth(this.mOnResult,this.writeChar),this.mEMVManager=new EMVManager(e),this.mKeyManager=new keyManager(e),this.mUpdateFirmware=new UpdateFirmwareManager(e),this.mGtMifareCardInfo=new GetMifareCardInfo(e),this.mpinOperation=new pinOperation(e),this.mNfcApdu=new NfcApdu(e),this.mgetPosInfo=new getPosInfo(e)},QPOSService.prototype.getQPosInfo=function(){this.mOnResult.getQPosInfo()},QPOSService.prototype.getQPosId=function(){this.mOnResult.getQPosId()},QPOSService.prototype.doTrade=function(e,t){this.mDoTrade.doTrade(e,t)},QPOSService.prototype.sendPin=function(e){this.mDoTrade.sendPin(e)},QPOSService.prototype.doCheckCard=function(e,t){this.mDoTrade.doCheckCard(e,t)},QPOSService.prototype.selectEmvApp=function(e){this.mDoTrade.selectEmvApp(e)},QPOSService.prototype.sendOnlineProcessResult=function(e){this.mDoTrade.sendOnlineProcessResult(e)},QPOSService.prototype.testCommand=function(e){this.mDoTrade.testCommand(e)},QPOSService.prototype.getNFCBatchData=function(e,t){return this.mDoTrade.getNFCBatchData(e,t)},QPOSService.prototype.resetPosStatus=function(){resetQPosStatus()},QPOSService.prototype.updateEmvAPP=function(e,t){this.mEMVManager.updateEmvAPP(e,t)},QPOSService.prototype.updateEmvCAPK=function(e,t){this.mEMVManager.updateEmvCAPK(e,t)},QPOSService.prototype.updateEmvConfig=function(e,t){this.mEMVManager.updateEmvConfig(e,t)},QPOSService.prototype.updateEMVConfigByXml=function(e){this.mEMVManager.updateEMVConfigByXml(e)},QPOSService.prototype.showEMVListOfXml=function(e){this.mEMVManager.showEMVListOfXml(e)},QPOSService.prototype.getICCTag=function(e,t,n,r,a){return this.mDoTrade.getICCTag(e,t,n,r,a)},QPOSService.prototype.getNewICCTag=function(e,t,n,r,a){return this.mDoTrade.getNewICCTag(e,t,n,r,a)},QPOSService.prototype.setMasterKey=function(e,t,n,r){this.mKeyManager.setMasterKey(e,t,n,r)},QPOSService.prototype.udpateWorkKey=function(e,t,n,r,a,o,s,i){this.mKeyManager.udpateWorkKey(e,t,n,r,a,o,s,i)},QPOSService.prototype.doUpdateIPEKOperation=function(e,t,n,r,a,o,s,i,u,l){this.mKeyManager.doUpdateIPEKOperation(e,t,n,r,a,o,s,i,u,l)},QPOSService.prototype.lcdShowCustomDisplay=function(e,t,n){this.mKeyManager.lcdShowCustomDisplay(e,t,n)},QPOSService.prototype.lcdShowCloseDisplay=function(){this.mKeyManager.lcdShowCloseDisplay()},QPOSService.prototype.doInputCustomStr=function(e,t,n,r,a,o){this.mKeyManager.doInputCustomStr(e,t,n,r,a,o)},QPOSService.prototype.pollOnMifareCard=function(e){this.mGtMifareCardInfo.pollOnMifareCard(e)},QPOSService.prototype.finishMifareCard=function(e){this.mGtMifareCardInfo.finishMifareCard(e)},QPOSService.prototype.setInputCsutomStr=function(e,t,n,r){this.mpinOperation.setInputCsutomStr(e,t,n,r)},QPOSService.prototype.updatePosFirmware=function(e,t){this.mUpdateFirmware.updatePosFirmware(e,t)},QPOSService.prototype.sendApduByNFC=function(e,t){this.mNfcApdu.sendApduByNFC(e,t)},QPOSService.prototype.powerOnNFC=function(e){this.mNfcApdu.powerOnNFC(e)},QPOSService.prototype.powerOffNFC=function(e){this.mNfcApdu.powerOffNFC(e)},QPOSService.prototype.setCommunicationMode=function(e){myConnectType=e},QPOSService.prototype.doSetBuzzerOperation=function(e){this.mgetPosInfo.doSetBuzzerOperation(e)},QPOSService.prototype.setIsSupportClsSelectEmvAPP=function(e){this.mDoTrade.setIsSupportClsSelectEmvAPP(e)},QPOSService.prototype.getPin=function(e,t,n,r,a,o,s){this.mDoTrade.getPin(e,t,n,r,a,o,s)},function(e){writeObj(e),writeObj(mOnResult=e)}),onConnect=function(e){void 0!==e&&(chrome.serial.onReceive.addListener(onReceiveCallbackSerial),connectionId=e.connectionId)},onReceiveCallbackSerial=function(e){setNotifyReceiveData(!0),e=e.data,e=new DataView(e),printDataView(e),appendData(e)};function connectToDeviceSerial(e){chrome.serial.connect(e,{bitrate:9600},onConnect)}function disconnectToDevice(e){chrome.serial.disconnect(connectionId,e)}var notifyReceiveData=!1;function setNotifyReceiveData(e){notifyReceiveData=e}function getNotifyReceiveData(){return notifyReceiveData}var mUpdateFlag=!1;function setUpdate(e){mUpdateFlag=e}function packageInstructionQue(){CommandDownlink4(CmdId.CMDID_QUERY,0,0,90);var e=getDownPBytes();return new Uint8Array(e).buffer}function packageInstructionPart(){CommandDownlink4(CmdId.CMDID_PART_DATA,0,0,90);var e=getDownPBytes();return new Uint8Array(e).buffer}function packageInstructionReset(){CommandDownlink4(CmdId.CMDID_RESET,0,0,15);var e=getDownPBytes();return new Uint8Array(e).buffer}function basicWriteSerial(e){chrome.serial.send(connectionId,e,console.log.bind(console))}function writePromiseSerial(e){setNotifyReceiveData(!1),clearReadbuffer(),basicWriteSerial(e)}SerialManager.prototype.startSessionSerial=function(e,t,n){startSessionSerial(e,t,n)};var bufData="",bufLen=0,result=null;function startSessionSerial(e,t,n){n*=100,result=null,writePromiseSerial(e),readSerialDataBuffer(t,n,function e(){readSerialDataBuffer(t,--n,e)})}function readSerialDataBuffer(e,t,n){setTimeout(function(){if(t<=0)return void initPartBuffer();if(getNotifyReceiveData()){var r,a=readBufferData();if(null==a)return void initPartBuffer();printDataView(a),isCompleteInstruction()?"24"!=(a=dataView2Hex(a)).substring(6,8)?"36"==a.substring(6,8)?(bufLen=parseInt(a.substring(14,18),16),bufData+=a.substring(18,18+2*bufLen),startSession(packageInstructionPart(),e,90)):"23"==a.substring(6,8)||"41"==a.substring(6,8)||"43"==a.substring(6,8)||"42"==a.substring(6,8)||"52"==a.substring(6,8)?startSession(packageInstructionQue(),e,90):(packet2(hexStr2Bytes(a)),mOnResult.checkCmdId()):(0!=bufLen?(r=parseInt(a.substring(14,18),16),packageCommandUplink(r=a.substring(8,18)+bufData+a.substring(18,18+2*r))):packet2(hexStr2Bytes(a)),initPartBuffer(),validPCRC()&&mOnResult.checkCmdId()&&(null!=e?e(byteArray2Hex(getAllBytes())):result=byteArray2Hex(getAllBytes()))):n()}else n()},10)}function initPartBuffer(){bufData="",bufLen=0}function startSysSessionSerial(e,t,n){return new Promise(function(r,a){result=null,writePromiseSerial(e),readSysSerialDataBuffer(t,n*=100,function e(){readSysSerialDataBuffer(t,--n,e,r,a)},r,a)})}function readSysSerialDataBuffer(e,t,n,r,a){setTimeout(function(){if(o<=0)return initPartBuffer(),void a("time out");if(getNotifyReceiveData()){var t=readBufferData();if(null==t)return initPartBuffer(),void a("onError(Error.UNKNOWN)");if(printDataView(t),isCompleteInstruction()&&!mUpdateFlag){var o,s,i=dataView2Hex(t);"24"!=i.substring(6,8)?"36"==i.substring(6,8)?(s=function t(){readSysSerialDataBuffer(e,--o,t,r,a)},bufLen=parseInt(i.substring(14,18),16),bufData+=i.substring(18,18+2*bufLen),result=null,writePromiseSerial(packageInstructionPart()),readSysSerialDataBuffer(e,o=500,s,r,a)):"23"==i.substring(6,8)||"41"==i.substring(6,8)||"43"==i.substring(6,8)||"42"==i.substring(6,8)||"52"==i.substring(6,8)?(s=function t(){readSysSerialDataBuffer(e,--o,t,r,a)},result=null,writePromiseSerial(packageInstructionQue()),readSysSerialDataBuffer(e,o=500,s,r,a)):(packet2(hexStr2Bytes(i)),mOnResult.checkCmdId()):(0!=bufLen?(s=parseInt(i.substring(14,18),16),packageCommandUplink(s=i.substring(8,18)+bufData+i.substring(18,18+2*s))):packet2(hexStr2Bytes(i)),initPartBuffer(),validPCRC()&&(mOnResult.checkCmdId()?null!=e?e(byteArray2Hex(getAllBytes())):(result=byteArray2Hex(getAllBytes()),r(result)):a("data verify error")))}else if(mUpdateFlag){for(var u=Array(t.byteLength),l=0;l<t.byteLength;l++)u[l]=t.getUint8(l);t.getUint8(11)==calPCRC(u)&&(null!=e?e(i):r(result=i))}else n()}else n()},10)}SerialManager.prototype.startSysSessionSerial=function(e,t,n){return startSysSessionSerial(e,t,n)};var connectedDevice,connectedServer,mListener,MPOS_SERVICE="49535343-fe7d-4ae5-8fa9-9fafd205e455",MPOS_VALUE="49535343-8841-43f4-a8d4-ecbe34729bb3",notify_uuid="49535343-1e4d-4bd9-ba61-23c647249616",IS_MPOS_SERVICE_FLAG=!1,UpdateFirmwareManager=function(e){writeObj(e),mListener=e,writeObj(this)};function updatePosFirmware(e){var t;myConnectType==CommunicationMode.USB?(setUpdateData(e),startUpdateFirmware()):(CommandDownlink(17,48,5),t=getDownPBytes(),startSysSession(new Uint8Array(t).buffer,null,5).then(function(t){var n,r,a,o;0==getResult()&&(n=0,hex2Ascii(byteArray2Hex(getUpPBytes(1,a=getUpPByte(n++)))),n+=a,a=getUpPByte(n++),hex2Ascii(byteArray2Hex(getUpPBytes(n,a))),n+=a,a=getUpPByte(n++),hex2Ascii(byteArray2Hex(getUpPBytes(n,a))),n+=a,a=getUpPByte(n++),byteArrayToInt(getUpPBytes(n,a)),n+=a,a=getUpPByte(n++),r="00"==(r=byteArray2Hex(getUpPBytes(n,a)))?"false":"true",n+=a,a=getUpPByte(n++),o="00"==(o=byteArray2Hex(getUpPBytes(n,a)))?"false":"true",n+=a,0==r.search("true")||0==o.search("true")?(setUpdateData(e),startUpdateFirmware()):myConnectType==CommunicationMode.UART?(Tip.d("BusinessMode_UPGRADE_CPU  VPosUart"),startUpdateFirmware()):mListener.onUpdatePosFirmwareResult(!1,UpdateInformationResult.UPDATE_NOT_KEEP_CHARGING))},function(t){setUpdateData(e),startUpdateFirmware()}))}UpdateFirmwareManager.prototype.updatePosFirmware=function(e,t){isRealUpdate=!0,connectedDevice=myConnectType==CommunicationMode.BLUETOOTH?t:mDevice,updatePosFirmware(e)};var upgPack_totalLen,g_UpgPackDataLen=0,g_UpgPackData=[],g_UpgPackDataIndex=0;function setUpdateData(e){var e=hexStr2Bytes(e),t=e.length-32;arrCopyArr(e,32,g_UpgPackData=Array(t),0,t),g_UpgPackDataLen=upgPack_totalLen=t,g_UpgPackDataIndex=0}function getUpgraderProgress(){var e;return g_UpgPackDataIndex<upgPack_totalLen?(e=(e=(100*g_UpgPackDataIndex/upgPack_totalLen).toFixed(2)).toString()).split(".")[0]:"100"}var isRealUpdate=!1;function startUpdateFirmware(){if(isRealUpdate){if(0==g_UpgPackDataLen)return connectedDevice=null,void mListener.onUpdatePosFirmwareResult(!0,UpdateInformationResult.UPDATE_SUCCESS);var e=g_UpgPackData[g_UpgPackDataIndex],t=[,,],t=(t[0]=g_UpgPackData[g_UpgPackDataIndex+1],t[1]=g_UpgPackData[g_UpgPackDataIndex+2],byteArrayToInt(t)),n=Array(t);switch(arrCopyArr(g_UpgPackData,g_UpgPackDataIndex+3,n,0,t),g_UpgPackDataIndex+=t+3,g_UpgPackDataLen-=t+3,getProgress(getUpgraderProgress()),e){case 2:doWorkbyT0x02(n);break;case 3:doWorkbyT0x03();break;case 4:doWorkbyT0x04();break;case 17:doWorkbyT0x11(n);break;case 18:doWorkbyT0x12(n)}}}function doWorkbyT0x02(e){e=byteArrayToInt(e),setTimeout(function(){startUpdateFirmware()},1e3*(e*=2))}var conCou=0;function doWorkbyT0x03(){myConnectType==CommunicationMode.BLUETOOTH?connectFixedDevice().then(function(e){startUpdateFirmware()},function(e){++conCou<3?setTimeout(function(){doWorkbyT0x03()},500):(mListener.onUpdatePosFirmwareResult(!1,UpdateInformationResult.UPDATE_FAIL),setUpdate(!1))}):myConnectType==CommunicationMode.USB&&(mService.setCommunicationMode(CommunicationMode.USB),connectedDevice.opened?startUpdateFirmware():connectToFixedDeviceUSB())}function doWorkbyT0x04(){myConnectType==CommunicationMode.BLUETOOTH?(connectedDevice.gatt.disconnect(),setTimeout(function(){startUpdateFirmware()},2e3)):myConnectType==CommunicationMode.USB&&connectedDevice.close().then(function(e){button.innerHTML="usb Connect",startUpdateFirmware()},function(e){})}function doWorkbyT0x11(e){setUpdate(!0),startSysSession(new Uint8Array(e).buffer,null,5).then(function(e){if(0==(e=hexStr2Bytes(e)).length||0!=e[6])return mListener.onUpdatePosFirmwareResult(!1,UpdateInformationResult.UPDATE_FAIL),void setUpdate(!1);setUpdate(!1),startUpdateFirmware()},function(e){setUpdate(!1),mListener.onUpdatePosFirmwareResult(!1,UpdateInformationResult.UPDATE_FAIL)})}function doWorkbyT0x12(e){setUpdate(!0),startSysSession(new Uint8Array(e).buffer,null,5).then(function(e){hexStr2Bytes(e)[3]==CmdId.CMDID_CRCERROR?(mListener.onUpdatePosFirmwareResult(!1,UpdateInformationResult.UPDATE_PACKET_VEFIRY_ERROR),setUpdate(!1)):(setUpdate(!1),startUpdateFirmware())},function(e){setUpdate(!1),mListener.onUpdatePosFirmwareResult(!1,UpdateInformationResult.UPDATE_LOWPOWER)})}function connectFixedDevice(){return new Promise(function(e,t){connectToDevice(connectedDevice,e,t)})}function connectToDevice(e,t,n){var r=!1;connectedDevice.gatt.connected?t():e.gatt.connect().then(function(a){connectedServer=a,e.addEventListener("gattserverdisconnected",function(){n()});var o=0;connectedServer.getPrimaryServices().then(function(e){var n=e.length;e.forEach(function(e){e.uuid==MPOS_SERVICE&&(IS_MPOS_SERVICE_FLAG=!0),e.getCharacteristics().then(function(e){o++;var a=0,s=e.length;e.forEach(function(e){a++,e.uuid==MPOS_VALUE?(writeChar=e,r=!0,mService.setCommunicationMode(CommunicationMode.BLUETOOTH),new webBluetooth(mOnResult,writeChar)):e.uuid==notify_uuid&&registNotify(MPOS_Notify_State=e),o==n&&a==s&&r&&t()})})})})},function(e){n()})}function connectToFixedDeviceUSB(){mListener.reOpen()}function connectToDeviceUSBByUSb(e,t,n){e.opened?t():e.open().then(function(){return mConfiguration=e.configuration,null===e.configuration&&e.selectConfiguration(1),e.claimInterface(0)}).then(function(){mControlEndpoint=(controlInterface=mConfiguration.interfaces[0]).alternates[0].endpoints[0];var n=(mDataInterface=e.configuration.interfaces[0]).alternates[0].endpoints[1];"out"==n.direction&&"bulk"==n.type?(mWriteEndpoint=n,mReadEndpoint=mDataInterface.alternates[0].endpoints[0]):"in"==n.direction&&"bulk"==n.type&&(mReadEndpoint=n,mWriteEndpoint=mDataInterface.alternates[0].endpoints[0]),t()})}function _defineProperties(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function _createClass(e,t,n){return t&&_defineProperties(e.prototype,t),n&&_defineProperties(e,n),Object.defineProperty(e,"prototype",{writable:!1}),e}function _classCallCheck(e,t){if(!(e instanceof t))throw TypeError("Cannot call a class as a function")}var mDevice,controlInterface,mDataInterface,mConfiguration,mControlEndpoint,mReadEndpoint,mWriteEndpoint,UsbManager=_createClass(function e(t){_classCallCheck(this,e),writeObj(t),writeObj(mOnResult=t)}),onReceiveCallbackUSB=(UsbManager.prototype.startSessionUSB=function(e,t,n){startSessionUSB(e,t,n)},function(e){setNotifyReceiveData(!0),printDataView(e),appendData(e)});function connectToDeviceUSB(){navigator.usb.requestDevice({filters:[{vendorId:938}]}).then(function(e){mDevice=e,button.innerHTML="Disconnect",OpenDevice(e)}).catch(function(e){})}function disconnectToDeviceUSB(e){null!=mDevice&&mDevice.close()}function OpenDevice(e){e.open().then(function(){return mConfiguration=e.configuration,null===e.configuration?e.selectConfiguration(1):e.claimInterface(0)}).then(function(){mControlEndpoint=(controlInterface=mConfiguration.interfaces[0]).alternates[0].endpoints[0];var t=(mDataInterface=e.configuration.interfaces[0]).alternates[0].endpoints[1];"out"==t.direction&&"bulk"==t.type?(mWriteEndpoint=t,mReadEndpoint=mDataInterface.alternates[0].endpoints[0]):"in"==t.direction&&"bulk"==t.type&&(mReadEndpoint=t,mWriteEndpoint=mDataInterface.alternates[0].endpoints[0]),startUpdateFirmware()})}function basicWriteUSB(e){mDevice.transferOut(mWriteEndpoint.endpointNumber,e).then(function(e){},function(e){}),mDevice.transferIn(mReadEndpoint.endpointNumber,1024).then(function(e){e.data&&"ok"===e.status&&onReceiveCallbackUSB(e.data),"stall"===e.status&&mDevice.clearHalt(1)})}function writePromiseUSB(e){setNotifyReceiveData(!1),clearReadbuffer(),basicWriteUSB(e)}function startSessionUSB(e,t,n){n*=100,result=null,writePromiseUSB(e),readUSBDataBuffer(t,n,function e(){readUSBDataBuffer(t,--n,e)})}function readUSBDataBuffer(e,t,n){setTimeout(function(){if(t<=0)return void initPartBuffer();if(getNotifyReceiveData()){var r,a=readBufferData();if(null==a)return void initPartBuffer();printDataView(a),isCompleteInstruction()?"24"!=(a=dataView2Hex(a)).substring(6,8)?"36"==a.substring(6,8)?(bufLen=parseInt(a.substring(14,18),16),bufData+=a.substring(18,18+2*bufLen),startSessionUSB(packageInstructionPart(),e,90)):"23"==a.substring(6,8)||"41"==a.substring(6,8)||"43"==a.substring(6,8)||"42"==a.substring(6,8)||"52"==a.substring(6,8)?startSessionUSB(packageInstructionQue(),e,90):(packet2(hexStr2Bytes(a)),mOnResult.checkCmdId()):(0!=bufLen?(r=parseInt(a.substring(14,18),16),packageCommandUplink(r=a.substring(8,18)+bufData+a.substring(18,18+2*r))):packet2(hexStr2Bytes(a)),initPartBuffer(),validPCRC()&&mOnResult.checkCmdId()&&(null!=e?e(byteArray2Hex(getAllBytes())):result=byteArray2Hex(getAllBytes()))):n()}else n()},10)}function startSysSessionUSB(e,t,n){return new Promise(function(r,a){result=null,writePromiseUSB(e),readSysUSBDataBuffer(t,n*=100,function e(){readSysUSBDataBuffer(t,--n,e,r,a)},r,a)})}function readSysUSBDataBuffer(e,t,n,r,a){setTimeout(function(){if(o<=0)return initPartBuffer(),void a("time out");if(getNotifyReceiveData()){var t=readBufferData();if(null==t)return initPartBuffer(),void a("onError(Error.UNKNOWN)");if(printDataView(t),isCompleteInstruction()&&!mUpdateFlag){var o,s,i=dataView2Hex(t);"24"!=i.substring(6,8)?"36"==i.substring(6,8)?(s=function t(){readSysUSBDataBuffer(e,--o,t,r,a)},bufLen=parseInt(i.substring(14,18),16),bufData+=i.substring(18,18+2*bufLen),result=null,writePromiseUSB(packageInstructionPart()),readSysUSBDataBuffer(e,o=500,s,r,a)):"23"==i.substring(6,8)||"41"==i.substring(6,8)||"43"==i.substring(6,8)||"42"==i.substring(6,8)||"52"==i.substring(6,8)?(s=function t(){readSysUSBDataBuffer(e,--o,t,r,a)},result=null,writePromiseUSB(packageInstructionQue()),readSysUSBDataBuffer(e,o=500,s,r,a)):(packet2(hexStr2Bytes(i)),mOnResult.checkCmdId()):(0!=bufLen?(s=parseInt(i.substring(14,18),16),packageCommandUplink(s=i.substring(8,18)+bufData+i.substring(18,18+2*s))):packet2(hexStr2Bytes(i)),initPartBuffer(),validPCRC()&&(mOnResult.checkCmdId()?null!=e?e(byteArray2Hex(getAllBytes())):(result=byteArray2Hex(getAllBytes()),r(result)):a("data verify error")))}else if(mUpdateFlag){for(var u=Array(t.byteLength),l=0;l<t.byteLength;l++)u[l]=t.getUint8(l);t.getUint8(t.byteLength-1)==calPCRC(u)&&(null!=e?e(i):(result=dataView2Hex(t),r(result)))}else n()}else n()},10)}function uuidFormat(e){if(null!=e)return"0x"+e.substring(4,13).toUpperCase()}function writeObj(e){for(var t in e)e[t]}function hexStr2Bytes(e){var t=0;if(""==(e=e.includes("0x")?e.replace("0x",""):e))return[];var n=e.length;if(n%2!=0)return null;n/=2;for(var r=[],a=0;a<n;a++){var o=e.substr(t,2),o=parseInt(o,16);r.push(o),t+=2}return r}function byteArray2Hex(e){return Array.prototype.map.call(new Uint8Array(e),function(e){return("00"+e.toString(16)).slice(-2)}).join("")}function stringToBytes(e){for(var t,n,r=[],a=0;a<e.length;a++){for(t=e.charCodeAt(a),n=[];n.push(255&t),t>>=8;);r=r.concat(n.reverse())}return r}function sleep(e){for(var t=new Date,n=t.getTime()+e;;)if((t=new Date).getTime()>n)return}function printDataView(e){for(var t=new Uint8Array(e.byteLength),n=0;n<e.byteLength;n++)t[n]=e.getUint8(n);byteArray2Hex(t)}function dataView2Hex(e){for(var t=new Uint8Array(e.byteLength),n=0;n<e.byteLength;n++)t[n]=e.getUint8(n);return byteArray2Hex(t)}function arrCopyArr(e,t,n,r,a){for(var o=t;o<t+a;o++)n[r]=e[o],r++;return n}function toHex(e){return e<16?"0x0"+e.toString(16).toUpperCase():"0x"+e.toString(16).toUpperCase()}function calCRC(e){for(var t=e[0],n=1;n<e.length;n++)t^=e[n];return t}function copyArr(e,t,n,r,a){for(var o=r,s=new DataView(n),i=t+a,u=new DataView(e),l=t;l<i;l++){var C=u.getUint8(l);s.setUint8(o,C),o++}return n}function getBytesFromArr(e,t,n){return n.slice(e,e+t)}function ab2str(e){return String.fromCharCode.apply(null,new Uint16Array(e))}function byteArrayToInt(e){for(var t=0,n=0;n<e.length;n++)t=(t<<=8)|255&e[n];return t}function Str2Bytes(e){var t=0;if(""==e)return[];var n=e.length;if(n%2!=0)return null;n/=2;for(var r=[],a=0;a<n;a++){var o=e.substr(t,2),o=parseInt(o,16);r.push(o),t+=2}return r}function intToHex(e){return Str2Bytes(e=(e=!(0<=e&&e<16)&&16<=e&&e<256?e.toString(16):"0"+e.toString(16)).length%2!=0&&"0"==e.charAt(0)?e.substring(1):e)}function intToHexValue(e){return e=!(0<=e&&e<16)&&16<=e&&e<256?e.toString(16):"0"+e.toString(16)}var CLICKTAG=0;function button_onclick(e){0==CLICKTAG&&(CLICKTAG=1,e.disabled=!0,setTimeout(function(){CLICKTAG=0,e.disabled=!1},3e3))}function getDate(){var e=new Date,t=e.getFullYear(),n=e.getMonth()+1,r=e.getDate(),a=e.getHours(),o=e.getMinutes(),s=e.getSeconds(),e=e.getMilliseconds();return t+"-"+conver(n)+"-"+conver(r)+" "+conver(a)+":"+conver(o)+":"+conver(s)+":"+e}function conver(e){return e<10?"0"+e:e}var writeChar,mOnResult,loAZ="abcdefghijklmnopqrstuvwxyz";function hex2Ascii(e){for(var t=e.toLowerCase(),n="0123456789abcdef",r="",a=0,a=0;a<t.length;a+=2){var o=t.charAt(a),s=(":"==o&&(a++,o=t.charAt(a)),t.charAt(a+1)),o=n.indexOf(o)<<4,s=parseInt(o|=n.indexOf(s))-32,i="?";r+=i=0<=s&&o<=126?symbols.charAt(s):i}return r}function isEmpty(e){return null==e||void 0===e||""==e.trime}function getFormatDateyyyyMMddHHmmss(){var e=new Date;return e.getFullYear().toString()+conver(e.getMonth()+1)+conver(e.getDate())+conver(e.getHours())+conver(e.getMinutes())+conver(e.getSeconds())}function getUTF8Bytes(e){for(var t=[],n=e.length,r=0;r<n;++r){var a=e.charCodeAt(r);65536<=a&&a<=1114111?(t.push(a>>18|240),t.push(a>>12&63|128),t.push(a>>6&63|128),t.push(63&a|128)):2048<=a&&a<=65535?(t.push(a>>12|224),t.push(a>>6&63|128),t.push(63&a|128)):128<=a&&a<=2047?(t.push(a>>6|192),t.push(63&a|128)):t.push(a)}return t}function toGbkBytes(e){for(var t=[],n=0;n<e.length;n++){var r,a=e.charAt(n);"%"==a?(r=parseInt(r=e.charAt(n+1)+e.charAt(n+2),16),r|=-256,t.push(r),n+=2):t.push(a.charCodeAt())}return t}function asciiToHex(e){for(var t=[],n=0;n<e.length;n++){var r=e.charCodeAt(n).toString(16);t.push(r)}return t.join("")}var symbols=(symbols=(symbols=" !\\"#$%&'()*+,-./0123456789:;<=>?@")+loAZ.toUpperCase()+"[\\\\]^_\`")+loAZ+"{|}~",workBlob=new Blob(["var sh; onmessage = function(e) {  console.log('Message received from main script = '+e.data);  sh = this.setInterval(function(){postMessage(\\"worker 222===\\");  clearInterval(sh); },1000);}",]),myWorker=new Worker(URL.createObjectURL(workBlob)),webBluetooth=function(e,t){writeObj(e),this.mOnResult=e,this.writeChar=t,writeObj(mOnResult)};function registNotify(e){e.startNotifications().then(function(e){}).catch(function(e){}),basicReadBluetooth(e)}function startSessionBluetooth(e,t,n){n*=100,result=null,writePromiseBluetooth(e),readBluetoothDataBuffer(t,n,function e(){readBluetoothDataBuffer(t,--n,e)})}function basicReadBluetooth(e){e.addEventListener("characteristicvaluechanged",function(e){setNotifyReceiveData(!0),printDataView(e=e.target.value),appendData(e)}),e.startNotifications()}webBluetooth.prototype.startSessionBluetooth=function(e,t,n){startSessionBluetooth(e,t,n)},bufData="",bufLen=0,result=null;var write_Max_len=16,writePromiseCou=0;function basicWriteBluetooth(e,t,n){writeChar.writeValue(e).then(function(){},function(e){})}function writePromiseBluetooth(e){setNotifyReceiveData(!1);var t=e,e=(clearReadbuffer(),t.byteLength);if(e<=write_Max_len)basicWriteBluetooth(t,function(){},function(e){});else{for(var n,r=-1,a=0,a=e%write_Max_len==0?e/write_Max_len:(e-(r=e%write_Max_len))/write_Max_len+1,o=write_Max_len,s=0,i=[];0<a;)o=-1!=r&&1==a?r:write_Max_len,n=new ArrayBuffer(o),copyArr(t,s*write_Max_len,n,0,o),i[s]=n,a--,s++;writePromiseCou=0,basicMultisessionBluetooth(i,function(){},function(e){})}}function basicMultisessionBluetooth(e,t,n){writePromiseCou>=e.length||(writeChar.writeValueWithoutResponse(e[writePromiseCou]).then(function(){null!=t&&basicMultisessionBluetooth(e,t,n)},function(e){}),writePromiseCou++)}function startSysSessionBluetooth(e,t,n){return new Promise(function(r,a){result=null,writePromiseBluetooth(e),readSysBluetoothDataBuffer(t,n*=100,function e(){readSysBluetoothDataBuffer(t,--n,e,r,a)},r,a)})}function readBluetoothDataBuffer(e,t,n){setTimeout(function(){var r,a;return t<=0?void initPartBuffer():getNotifyReceiveData()?null==(r=readBufferData())?void initPartBuffer():void(isCompleteInstruction()?"24"!=(r=dataView2Hex(r)).substring(6,8)?"36"==r.substring(6,8)?(bufLen=parseInt(r.substring(14,18),16),bufData+=r.substring(18,18+2*bufLen),startSessionBluetooth(packageInstructionPart(),e,90)):"23"==r.substring(6,8)||"41"==r.substring(6,8)||"43"==r.substring(6,8)||"42"==r.substring(6,8)||"52"==r.substring(6,8)?void startSessionBluetooth(packageInstructionQue(),e,90):(packet2(hexStr2Bytes(r)),mOnResult.checkCmdId()):(0!=bufLen?(a=parseInt(r.substring(14,18),16),packageCommandUplink(a=r.substring(8,18)+bufData+r.substring(18,18+2*a))):packet2(hexStr2Bytes(r)),initPartBuffer(),validPCRC()&&mOnResult.checkCmdId()&&(null!=e?e(byteArray2Hex(getAllBytes())):result=byteArray2Hex(getAllBytes()))):n()):void n()},10)}function readSysBluetoothDataBuffer(e,t,n,r,a){myWorker.postMessage("== test =="),myWorker.onmessage=function(o){readMainBuffer(e,t,n,r,a)}}function readMainBuffer(e,t,n,r,a){if(t<=0)return initPartBuffer(),void a("time out");if(getNotifyReceiveData()){var o=readBufferData();if(null==o)return initPartBuffer(),void a("onError(Error.UNKNOWN)");if(isCompleteInstruction()&&!mUpdateFlag){var s=dataView2Hex(o);"24"!=s.substring(6,8)?"36"==s.substring(6,8)?(i=function n(){readSysBluetoothDataBuffer(e,--t,n,r,a)},bufLen=parseInt(s.substring(14,18),16),bufData+=s.substring(18,18+2*bufLen),result=null,writePromiseBluetooth(packageInstructionPart()),readSysBluetoothDataBuffer(e,t=500,i,r,a)):"23"==s.substring(6,8)||"41"==s.substring(6,8)||"43"==s.substring(6,8)||"42"==s.substring(6,8)||"52"==s.substring(6,8)?(i=function n(){readSysBluetoothDataBuffer(e,--t,n,r,a)},result=null,writePromiseBluetooth(packageInstructionQue()),readSysBluetoothDataBuffer(e,t=500,i,r,a)):(packet2(hexStr2Bytes(s)),mOnResult.checkCmdId()):(0!=bufLen?(i=parseInt(s.substring(14,18),16),packageCommandUplink(i=s.substring(8,18)+bufData+s.substring(18,18+2*i))):packet2(hexStr2Bytes(s)),initPartBuffer(),validPCRC()&&(mOnResult.checkCmdId()?null!=e?e(byteArray2Hex(getAllBytes())):(result=byteArray2Hex(getAllBytes()),r(result)):a("data verify error")))}else if(mUpdateFlag){for(var i,u=Array(o.byteLength),l=0;l<o.byteLength;l++)u[l]=o.getUint8(l);o.getUint8(o.byteLength-1)==calPCRC(u)?null!=e?e(s):(result=dataView2Hex(o),r(result)):null!=o?(i=function n(){readSysBluetoothDataBuffer(e,--t,n,r,a)},sleep(100),readSysBluetoothDataBuffer(e,t,i,r,a)):(result=dataView2Hex(o),r(result))}else n()}else n()}`;var g=(n=>(n.CUTE="CUTE",n.CR100="CR100",n.D20="D20",n.QPOSCUTE="QPOSCUTE",n))(g||{});(function(){if(!window.QPOSService){const n=document.createElement("script");n.textContent=E,document.head.appendChild(n)}})();const m={SERVICE_UUID:"49535343-fe7d-4ae5-8fa9-9fafd205e455",WRITE_UUID:"49535343-8841-43f4-a8d4-ecbe34729bb3",NOTIFY_UUID:"49535343-1e4d-4bd9-ba61-23c647249616",DEVICE_PREFIXES:["MPOS","QPOS","VEL","MIPS","watu","POINT"]};class _{constructor(e){c(this,"apiKey");c(this,"isConnected");c(this,"device");c(this,"writeCharacteristic");c(this,"eventListeners");c(this,"qposService");c(this,"deviceInfo");c(this,"userLocation");c(this,"currentTransactionDetails");c(this,"deviceInfoPromiseResolver");c(this,"posIdPromiseResolver");if(!e||!e.apiKey)throw new Error("CuboPagoSDK Error: El API Key es obligatorio para inicializar el SDK.");this.apiKey=e.apiKey,this.currentTransactionDetails=null,this.device=null,this.deviceInfo=null,this.deviceInfoPromiseResolver=null,this.posIdPromiseResolver=null,this.userLocation=null,this.writeCharacteristic=null,this.isConnected=!1,this.eventListeners={},this.qposService=new QPOSService,this.qposService.initListener(this),window.mOnResult=new QPOSAnalyResult(this),this._bindListenerMethods()}async connect(){this.isConnected&&this.disconnect();try{this._emit("status","searching");const e=await navigator.bluetooth.requestDevice({filters:m.DEVICE_PREFIXES.map(a=>({namePrefix:a})),optionalServices:[m.SERVICE_UUID]});if(this.device=e,e.addEventListener("gattserverdisconnected",()=>this._onDisconnected()),!this.device.gatt)throw new Error("No se encontró un servidor GATT en el dispositivo.");this._emit("status","connecting");const r=await(await e.gatt.connect()).getPrimaryService(m.SERVICE_UUID),[i,o]=await Promise.all([r.getCharacteristic(m.WRITE_UUID),r.getCharacteristic(m.NOTIFY_UUID)]);this.writeCharacteristic=i,window.writeChar=this.writeCharacteristic,registNotify(o),this.qposService.setCommunicationMode(CommunicationMode.BLUETOOTH),new webBluetooth(window.mOnResult,this.writeCharacteristic),this.isConnected=!0,this._emit("connected",{deviceName:this.device.name}),this._emit("status","connected");try{this.deviceInfo=await this.getDeviceInfo()}catch(a){console.error("No se pudo obtener la info del dispositivo al conectar:",a),this.deviceInfo=null}try{this.userLocation=await this._getCurrentLocation()}catch{this.userLocation=null}return this.device.name||this.device.id}catch(e){throw this._emit("error",{type:"connection_failed",message:e.message}),this._emit("status","disconnected"),this.disconnect(),e}}disconnect(){var e,t;(t=(e=this.device)==null?void 0:e.gatt)!=null&&t.connected?this.device.gatt.disconnect():this._onDisconnected()}getDeviceInfo(){return this.isConnected?new Promise((e,t)=>{this.deviceInfoPromiseResolver=e,this.qposService.getQPosInfo(),setTimeout(()=>{this.deviceInfoPromiseResolver=null,t(new Error("Timeout: No se recibió respuesta del dispositivo en 5 segundos."))},5e3)}):Promise.reject(new Error("No hay un dispositivo conectado."))}getPosId(){return this.isConnected?new Promise((e,t)=>{this.posIdPromiseResolver=e,this.qposService.getQPosId(),setTimeout(()=>{this.posIdPromiseResolver=null,t(new Error("Timeout: No se recibió respuesta del dispositivo en 5 segundos."))},5e3)}):Promise.reject(new Error("No hay un dispositivo conectado."))}startPayment(e){const{amount:t,currencyCode:r="0840",currencySymbol:i="$"}=e;if(!this.isConnected){const o=new Error("No estás conectado a un POS.");return this._emit("error",{type:"not_connected",message:o.message}),Promise.reject(o)}return this.currentTransactionDetails={amount:t,currencyCode:r},setAmountIcon(AmountType.MONEY_TYPE_CUSTOM_STR,i),setAmount(t,"",r,TransactionType.SALE),this.qposService.doCheckCard(0,60),Promise.resolve()}_handleSendOnlineProcessResult(e,t){this.qposService.sendOnlineProcessResult((t==="success"?"8A023030":"8A023035")+e)}on(e,t){this.eventListeners[e]||(this.eventListeners[e]=[]),this.eventListeners[e].push(t)}_emit(e,t){this.eventListeners[e]&&this.eventListeners[e].forEach(r=>{try{r(t)}catch(i){console.error(`Error in '${e}' event callback:`,i)}})}_bindListenerMethods(){["onQposInfoResult","onQposIdResult","onRequestWaitingUser","onDoTradeResult","onRequestOnlineProcess","onRequestSelectEmvApp","onError","onRequestDisplay","onRequestBatchData","onRequestTransactionResult"].forEach(t=>{const r=t;typeof this[r]=="function"&&(this[r]=this[r].bind(this))})}_onDisconnected(){this.isConnected&&(this.isConnected=!1,this.device=null,this.deviceInfo=null,this._emit("disconnected"),this._emit("status","disconnected"))}onRequestWaitingUser(e){this._emit("status","waiting_for_card")}async onDoTradeResult(e,t){var i,o;if(this._emit("loading",!0),this._emit("status","processing_payment"),e===s.ICC)return;if(e===s.MCR){this._emit("error",{type:"mcr_error",message:"Pago por banda no disponible, intente otro método."}),this._emit("status","payment_failed"),this._emit("loading",!1);return}const r=this._formatCardReadResult(e,t);this._emit("tradeResult",{resultType:e,data:r,deviceInfo:this.deviceInfo,amount:(i=this.currentTransactionDetails)==null?void 0:i.amount,currencyCode:(o=this.currentTransactionDetails)==null?void 0:o.currencyCode}),e===s.NFC_ONLINE&&this.qposService.getNFCBatchData(async a=>{try{const d=await this._buildApiPayload({batchData:a,readType:l.NFC,transactionType:u.POS}),C=await this._sendPaymentRequest(d);this._emit("transactionResult",{success:!0,data:C}),this._emit("status","payment_success")}catch(d){this._emit("transactionResult",{success:!1,error:d}),this._emit("status","payment_failed")}finally{this._emit("loading",!1)}},a=>{this._emit("error",{type:"nfc_batch_error",message:a}),this._emit("status","payment_failed"),this._emit("loading",!1)})}onError(e){this._emit("error",{type:"sdk_error",message:e})}onRequestBatchData(e){this._emit("batchData",{data:e})}onRequestTransactionResult(e){}async onRequestOnlineProcess(e){var t,r,i;try{const o=await this._buildApiPayload({batchData:e,readType:l.CHIP,transactionType:u.POS}),a=await this._sendPaymentRequest(o),d=((r=(t=a==null?void 0:a.data)==null?void 0:t.voucherData)==null?void 0:r.emvResponse)||"",C=(i=a==null?void 0:a.data)==null?void 0:i.status;this._handleSendOnlineProcessResult(d,C==="SUCCEEDED"?"success":"declined"),this._emit("transactionResult",{success:!0,data:a}),this._emit("status","payment_success")}catch(o){this._emit("transactionResult",{success:!1,error:o}),this._emit("status","payment_failed")}finally{this._emit("loading",!1)}}onRequestSelectEmvApp(e){this.qposService.selectEmvApp(0)}onQposInfoResult(e){this.deviceInfoPromiseResolver&&(this.deviceInfoPromiseResolver(e),this.deviceInfoPromiseResolver=null),this._emit("deviceInfo",e)}onQposIdResult(e){this.posIdPromiseResolver&&(this.posIdPromiseResolver(e),this.posIdPromiseResolver=null),this._emit("posIdResult",e)}onRequestDisplay(e){this._emit("display",e)}_getCurrentLocation(){return new Promise((e,t)=>{if(!navigator.geolocation)return t(new Error("La geolocalización no es soportada por este navegador."));navigator.geolocation.getCurrentPosition(r=>{e({lat:r.coords.latitude,lng:r.coords.longitude})},r=>{t(new Error(`Error al obtener la ubicación: ${r.message}`))})})}async _buildApiPayload(e){var C,p,y,f,A;const{batchData:t,readType:r,transactionType:i}=e,o=await this.getPosId(),a=((C=this.deviceInfo)==null?void 0:C.ModelInfor)===g.QPOSCUTE?"CUTE":((p=this.deviceInfo)==null?void 0:p.ModelInfor)??"UNKNOWN";return{amount:((y=this.currentTransactionDetails)==null?void 0:y.amount)||"0",cents:!0,currencyId:1,lng:((f=this.userLocation)==null?void 0:f.lng)||0,lat:((A=this.userLocation)==null?void 0:A.lat)||0,posInfo:{batchData:t,isFallback:!1,model:a,name:(o==null?void 0:o.posId)??"",readType:r},transactionType:i}}async _sendPaymentRequest(e){try{const t=await fetch("https://api-dev-1.cubopago.com/api/v1/transactions/pos-payments",{method:"POST",body:JSON.stringify(e),headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.apiKey}`}});if(!t.ok)throw new Error(`Error del servidor: ${t.status} ${t.statusText}`);return await t.json()}catch(t){throw t}}_formatCardReadResult(e,t){if(e!==s.MCR&&e!==s.NFC_ONLINE||!Array.isArray(t))return t;const[r,i,o,a,d,C,p,,y,f,A]=t.map(R=>R||"N/A");return{track1:r,track2:i,track3:o,formatId:a,cardNum:d,expiryDate:C,serviceCode:p,pinBlock:y,trackKsn:f,pinKsn:A}}}return _});
//# sourceMappingURL=cubo-pos-sdk-web.umd.js.map
